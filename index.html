<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Universe: Adaptive Learning App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* High Contrast Space Background */
            background: linear-gradient(135deg, #0f002a 0%, #3a005c 50%, #6d008d 100%);
            min-height: 100vh;
        }
        .math-card {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px; 
        }
        .btn-option, .btn-mode {
            transition: all 0.15s ease-in-out;
            border: 3px solid transparent;
        }
        .btn-option:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .problem-glow {
            animation: pulse-glow 2s infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 10px #ffeb3b, 0 0 20px #ffeb3b4d; }
            to { box-shadow: 0 0 20px #ffebeb3b, 0 0 30px #ffeb3b80; }
        }
        
        .animate-ping-once {
            animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1) 1;
        }
        @keyframes ping {
          75%, 100% {
            transform: scale(1.1);
            opacity: 0;
          }
        }
        
        .visual-container {
            min-height: 120px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 1rem;
        }

        /* --- Custom Styles for Visualization Blocks --- */
        /* Simple Counting Circles */
        .simple-symbol {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        /* Base 10 Ones Block */
        .one-block {
            width: 15px;
            height: 15px;
            margin: 2px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        /* Base 10 Tens Block (Rod) */
        .ten-block {
            width: 15px;
            height: 70px; 
            margin: 4px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        /* Base 10 Hundreds Block (Flat) */
        .hundred-block {
            width: 70px;
            height: 70px;
            margin: 4px 6px;
            border-radius: 6px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
        }
        .block-crossed {
            position: relative;
            opacity: 0.4;
        }
        .block-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: #dc2626; 
            transform: translateY(-50%) rotate(-45deg);
            opacity: 1;
            border-radius: 1px;
        }
        /* --- End Visualization Styles --- */

        /* High contrast colors for operations */
        .op-add { background-color: #059669; } /* Emerald */
        .op-sub { background-color: #dc2626; } /* Red */
        .op-mul { background-color: #f59e0b; } /* Amber */
        .op-div { background-color: #3b82f6; } /* Blue */
        .op-place { background-color: #9333ea; } /* Violet */
        .op-number-types { background-color: #10b981; } /* Emerald (different shade) */


        .active-op {
            background-color: #facc15 !important; /* Yellow */
            color: #4c1d95 !important; /* Purple text */
            box-shadow: 0 0 0 4px #facc15, 0 0 15px rgba(255, 255, 0, 0.7);
        }
        
        /* Custom Tailwind Switch */
        .toggle-switch-container input:checked ~ .toggle-bg {
            background-color: #8b5cf6; /* Violet-500 */
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <!-- Main Application Container -->
    <div id="app" class="w-full">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-yellow-300 tracking-tight mb-2">
                <span role="img" aria-label="Globe">🌎</span> Math Universe
            </h1>
            <p class="text-xl text-indigo-200">Learning Made Visual, Adaptive, and Free</p>
        </header>

        <!-- Math Card -->
        <div class="math-card bg-white p-6 sm:p-8 rounded-3xl shadow-2xl">
            
            <!-- Mode and Info Bar -->
            <div class="space-y-4 mb-6 border-b pb-4 border-indigo-100">
                
                <!-- Operation/Mode Selector -->
                <div id="modeSelector" class="grid grid-cols-3 sm:grid-cols-6 gap-3">
                    <button data-op="+" data-mode="arithmetic" class="btn-mode op-add text-white font-bold py-3 rounded-xl shadow-md">Addition (+)</button>
                    <button data-op="-" data-mode="arithmetic" class="btn-mode op-sub text-white font-bold py-3 rounded-xl shadow-md">Subtraction (-)</button>
                    <button data-op="*" data-mode="arithmetic" class="btn-mode op-mul text-white font-bold py-3 rounded-xl shadow-md">Multiplication (×)</button>
                    <button data-op="/" data-mode="arithmetic" class="btn-mode op-div text-white font-bold py-3 rounded-xl shadow-md">Division (÷)</button>
                    <button data-op="place_value" data-mode="place_value" class="btn-mode op-place text-white font-bold py-3 rounded-xl shadow-md">Place Value</button>
                    
                    <!-- Number Types Button -->
                    <button data-op="number_types" data-mode="number_types" class="btn-mode op-number-types text-white font-bold py-3 rounded-xl shadow-lg ring-2 ring-emerald-300">
                        <span class="hidden sm:inline">Number Types</span>
                        <span class="inline sm:hidden">Types</span>
                    </button>
                </div>

                <!-- Toggle for Regrouping/Borrowing -->
                <div id="regroupingToggleContainer" class="flex justify-between items-center bg-purple-100 p-3 rounded-lg shadow-inner" style="display: none;">
                    <span class="text-lg font-bold text-purple-900">Show Regrouping/Borrowing Steps (Advanced Subtraction)</span>
                    
                    <label for="regroupingToggle" class="flex items-center cursor-pointer toggle-switch-container">
                        <div class="relative">
                            <input type="checkbox" id="regroupingToggle" class="sr-only">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full toggle-bg transition-colors duration-300"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition shadow-md"></div>
                        </div>
                    </label>
                </div>

                <!-- Score, Level & Reset -->
                <div id="scoreInfo" class="flex justify-between items-center pt-2">
                    <div class="text-lg font-bold text-gray-700">
                        Score: <span id="score" class="text-green-600">0</span>
                    </div>
                    <div class="text-lg font-bold text-gray-700">
                        Skill Level: <span id="skillLevelDisplay" class="text-purple-600">1</span>
                    </div>
                    <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-150">
                        Reset Game
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="mainContent">
                <!-- Visualization Area -->
                <div id="visualizationArea" class="visual-container bg-purple-900/90 rounded-xl mb-4 text-center">
                    <!-- Initial Content for Visualization -->
                    <p class="text-white text-xl p-4">Select an operation to begin learning with interactive visualizations!</p>
                </div>

                <!-- Problem and Hint Display -->
                <div id="problemContainer" class="text-center p-6 bg-purple-100 rounded-xl mb-6">
                    <p id="problemText" class="text-3xl sm:text-4xl font-black text-purple-900 mb-2">
                        Select an operation to begin!
                    </p>
                    <button id="hintButton" class="bg-yellow-500 hover:bg-yellow-600 text-purple-900 font-bold py-2 px-4 rounded-full text-lg transition duration-150 shadow-md">
                        Need a Hint?
                    </button>
                </div>

                <!-- Options/Buttons -->
                <div id="optionsContainer" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
                
                <!-- Lesson Content Area -->
                <div id="lessonContentArea" class="hidden">
                    <!-- Lesson content will be dynamically loaded here -->
                </div>
            </div>
            
            <!-- Feedback Message -->
            <div id="feedbackContainer" class="mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center">
                <p id="feedbackMessage" class="text-lg font-semibold text-gray-600">Choose your operation above to start learning!</p>
            </div>
        </div>
        
        <!-- Accessibility Note -->
        <p class="text-center text-sm text-indigo-200 mt-4">
            Note: This layout uses high-contrast colors and clear, consistent visuals, supporting learners with various needs.
        </p>
    </div>

    <!-- JavaScript Game Logic -->
    <script>
        // Global variables for game state
        let score = 0;
        let skillLevel = 1; // AI-like adaptive difficulty
        let currentProblem = {};
        let currentMode = 'initial'; 
        let currentOperation = null; // Changed default to null
        let hintUsed = false;
        let showRegrouping = true; // Defaulted to TRUE to enable borrowing visuals

        // --- ADAPTIVE LOGIC VARIABLES ---
        let consecutiveCorrects = 0;
        const CORRECT_STREAK_REQUIRED = 10;
        // ------------------------------------

        // Settings
        const OPTIONS_RANGE = 5;
        const BASE_TEN_THRESHOLD = 20; // Use Base-Ten blocks when numbers are 20 or greater.

        // DOM elements (These are globally defined based on the initial HTML structure)
        const scoreElement = document.getElementById('score');
        const skillLevelDisplay = document.getElementById('skillLevelDisplay');
        const problemTextElement = document.getElementById('problemText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const problemContainer = document.getElementById('problemContainer');
        const visualizationArea = document.getElementById('visualizationArea');
        const hintButton = document.getElementById('hintButton');
        const regroupingToggle = document.getElementById('regroupingToggle');
        const regroupingToggleContainer = document.getElementById('regroupingToggleContainer');
        const scoreInfo = document.getElementById('scoreInfo'); 
        
        // LESSON AREA DOM ELEMENTS
        const lessonContentArea = document.getElementById('lessonContentArea');


        // --- Number Type Lesson Data (All LaTeX removed) ---
        const numberTypeLessons = {
            'even_odd': {
                title: "Even and Odd Numbers",
                icon: "✨",
                summary: "Numbers are **Even** if they can be split into two equal teams with nothing left over (they end in 0, 2, 4, 6, or 8). They are **Odd** if there's always one left out (they end in 1, 3, 5, 7, or 9).",
                examples: [
                    { title: "Even Example: Pairing Socks", text: "If you have 6 socks, you can make 3 perfect pairs (3 + 3 = 6). No sock is left alone. (6 is Even)" },
                    { title: "Odd Example: Sharing Cookies", text: "If you have 5 cookies to share equally between two friends, each friend gets 2, but 1 cookie is left over. (5 is Odd)" },
                    { title: "Seating Arrangement", text: "When setting up seats for a school play, if the number of seats is **Even** (like 100), every row can be full. If it's **Odd** (like 99), you will have one empty seat or a row with only one seat at the end." }
                ],
            },
            'prime_composite': {
                title: "Prime and Composite Numbers",
                icon: "💎",
                summary: "A **Prime** number is only divisible by **1** and itself (like **7** or **13**). A **Composite** number has more than two factors (like **6**, which is divisible by **1, 2, 3**, and **6**). The number **1** is neither prime nor composite!",
                examples: [
                    { title: "Prime Example: Building Arrays", text: "If you have 7 blocks, you can only make a single row of 7 or 7 rows of 1. It can't be arranged into any other neat rectangle (like 2 x 3). (7 is Prime)" },
                    { title: "Composite Example: Tiling a Floor", text: "If you have 12 tiles, you can arrange them in many ways: 1 x 12, 2 x 6, or 3 x 4. (12 is Composite)" },
                    { title: "Group Size", text: "When 17 friends want to play a game with equal teams, they can only make 1 team of 17 or 17 teams of 1. (Prime numbers make grouping difficult)." }
                ]
            },
            'fraction_decimal': {
                title: "Fractions and Decimals",
                icon: "🍕",
                summary: "**Fractions** and **Decimals** are two ways to write a part of a whole. A fraction uses a top number (numerator) and a bottom number (denominator), like 1/2. A decimal uses a point, like 0.5. They both represent the same amount!",
                examples: [
                    { title: "Pizza/Cake (Fractions)", text: "You cut a pizza into 8 slices. You eat 3 slices. You ate 3/8 of the pizza. The bottom number (8) is the whole, and the top number (3) is the part." },
                    { title: "Money (Decimals)", text: "When you buy something for one dollar and fifty cents, you write it as $1.50. The .50 is the decimal part, meaning 50 cents out of 100 cents (a whole dollar)." },
                    { title: "Baking Recipes (Fractions)", text: "A recipe might call for 3/4 cup of flour. You use measuring cups, which are often marked with common fractions like 1/2, 1/3, and 1/4." }
                ]
            }
        };

        // --- Visualization Helper Functions ---
        
        /**
         * Utility function to create a block element (replaces the placeholder '1' with an icon/block)
         */
        function createBlock(type, colorClass, crossed = false) {
            const block = document.createElement('div');
            block.className = `${type} ${colorClass} ${crossed ? 'block-crossed' : ''}`;
            return block;
        }

        /**
         * Renders small circles for simple numbers (under the BASE_TEN_THRESHOLD).
         */
        function renderSimpleSymbols(count, colorClass) {
            const container = document.createElement('div');
            container.className = 'flex flex-wrap justify-center items-center p-2';
            for (let i = 0; i < count; i++) {
                const symbol = createBlock('simple-symbol', colorClass);
                container.appendChild(symbol);
            }
            return container;
        }

        /**
         * Renders Base Ten elements (hundreds, tens, ones).
         */
        function renderBaseTenElements(count, colorClass) {
            const container = document.createElement('div');
            container.className = 'flex flex-wrap justify-center items-end p-2';

            let remaining = count;
            
            // Hundreds Blocks
            const hundreds = Math.floor(remaining / 100);
            remaining %= 100;
            for (let i = 0; i < hundreds; i++) {
                container.appendChild(createBlock('hundred-block', colorClass));
            }
            
            // Tens Blocks (Rods)
            const tens = Math.floor(remaining / 10);
            remaining %= 10;
            for (let i = 0; i < tens; i++) {
                container.appendChild(createBlock('ten-block', colorClass));
            }
            
            // Ones Blocks
            for (let i = 0; i < remaining; i++) {
                container.appendChild(createBlock('one-block', colorClass));
            }

            return container;
        }

        /**
         * Main visualization renderer for arithmetic problems.
         */
        function renderVisualization(num1, num2, operator) {
            
            visualizationArea.innerHTML = '';
            visualizationArea.style.display = 'flex';
            visualizationArea.className = 'visual-container bg-purple-900/90 rounded-xl mb-4 text-center flex flex-col justify-center items-center';

            if (operator !== '+') {
                 // Only implementing addition visuals for now
                 visualizationArea.innerHTML = '<p class="text-white text-xl p-4">Visualizations for this operation are coming soon!</p>';
                 return;
            }
            
            // Determine which rendering style to use (simple dots or Base Ten blocks)
            const useBaseTen = num1 >= BASE_TEN_THRESHOLD || num2 >= BASE_TEN_THRESHOLD;

            // 1. Render num1 (First Operand)
            const block1 = document.createElement('div');
            block1.className = 'flex flex-col items-center p-3 m-2 bg-purple-700/50 rounded-lg shadow-inner';
            block1.innerHTML = `<p class="text-white font-bold text-lg mb-2">${num1}</p>`;
            
            if (useBaseTen) {
                block1.appendChild(renderBaseTenElements(num1, 'bg-green-500'));
            } else {
                block1.appendChild(renderSimpleSymbols(num1, 'bg-green-500'));
            }

            // 2. Render operator sign
            const sign = document.createElement('div');
            sign.className = 'text-5xl font-extrabold text-yellow-300 mx-4 self-center';
            sign.textContent = operator;
            
            // 3. Render num2 (Second Operand)
            const block2 = document.createElement('div');
            block2.className = 'flex flex-col items-center p-3 m-2 bg-purple-700/50 rounded-lg shadow-inner';
            block2.innerHTML = `<p class="text-white font-bold text-lg mb-2">${num2}</p>`;
            
            if (useBaseTen) {
                block2.appendChild(renderBaseTenElements(num2, 'bg-red-500'));
            } else {
                block2.appendChild(renderSimpleSymbols(num2, 'bg-red-500'));
            }
            
            // Assemble the main visual line
            const visualLine = document.createElement('div');
            visualLine.className = 'flex flex-wrap justify-center items-start w-full max-w-4xl p-2';
            visualLine.appendChild(block1);
            visualLine.appendChild(sign);
            visualLine.appendChild(block2);

            visualizationArea.appendChild(visualLine);

            // Remove problem-glow temporarily while the problem is loading
            problemContainer.classList.remove('problem-glow');
            setTimeout(() => {
                if (currentMode !== 'number_types') {
                     problemContainer.classList.add('problem-glow');
                }
            }, 100);
        }
        
        // Function to check the answer (placeholder, as options are used)
        function checkAnswer(selectedOption) {
            const isCorrect = selectedOption === currentProblem.answer;

            if (isCorrect) {
                score++;
                scoreElement.textContent = score;
                adjustSkill(true);
            } else {
                adjustSkill(false);
            }

            // Always move to the next problem immediately after an answer is chosen
            setTimeout(generateProblem, 500); 
        }

        // --- Core Arithmetic and Game Logic ---

        /**
         * Displays the tutorial for the Addition concept with multiple real-life examples.
         */
        function displayAdditionTutorial() {
            // Hide game elements
            scoreInfo.classList.add('hidden');
            regroupingToggleContainer.style.display = 'none';
            optionsContainer.innerHTML = '';
            optionsContainer.classList.add('hidden');
            
            // MANDATORY CHANGE: Hide the Hint Button when in Learning/Tutorial Mode
            hintButton.style.display = 'none'; 
            
            problemContainer.classList.remove('problem-glow');
            
            // MANDATORY CHANGE: Hide the Visualization Area when in Learning/Tutorial Mode
            visualizationArea.style.display = 'none'; 
            visualizationArea.innerHTML = ''; // Clear any previous content

            // Update problem container for the lesson
            problemTextElement.innerHTML = `<span class="text-4xl sm:text-5xl font-extrabold text-purple-900">Let's Learn Addition!</span>`;
            
            lessonContentArea.classList.remove('hidden');
            lessonContentArea.innerHTML = `
                <div class="space-y-8 text-center">
                    <div class="bg-indigo-100 p-6 rounded-2xl shadow-xl border-b-4 border-indigo-700">
                        <p class="text-2xl text-indigo-900 font-extrabold mb-3">
                            Addition means **putting groups together** to find the **TOTAL**!
                        </p>
                        <p class="text-xl text-gray-700">
                            We use the addition sign (+) to combine numbers.
                        </p>
                    </div>

                    <div class="space-y-4 text-left p-4 bg-white rounded-xl shadow-lg">
                        <h3 class="text-3xl font-extrabold text-green-700 mb-4 text-center">Examples:</h3>
                        
                        <!-- Example 1: Toys -->
                        <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500 shadow-md">
                            <p class="text-xl font-bold text-gray-900 mb-1">🧸 Toy Example:</p>
                            <p class="text-lg text-gray-700">
                                You have 2 blue cars and your friend gives you 3 red trucks.
                                If you add them up, you have 2 + 3 = 5 toys!
                            </p>
                        </div>
                        
                        <!-- Example 2: Food -->
                        <div class="p-4 bg-red-50 rounded-lg border-l-4 border-red-500 shadow-md">
                            <p class="text-xl font-bold text-gray-900 mb-1">🍪 Cookie Example:</p>
                            <p class="text-lg text-gray-700">
                                You bake 5 cookies in the morning and 5 more cookies in the afternoon.
                                In total, you baked 5 + 5 = 10 cookies! That's a lot of snacks!
                            </p>
                        </div>

                        <!-- Example 3: Nature/Animals -->
                        <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 shadow-md">
                            <p class="text-xl font-bold text-gray-900 mb-1">🐦 Bird Example:</p>
                            <p class="text-lg text-gray-700">
                                You see 1 bird on a fence. Then, 6 more birds land next to it.
                                Now you see 1 + 6 = 7 birds all together!
                            </p>
                        </div>

                        <!-- Example 4: Money/Shopping -->
                        <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500 shadow-md">
                            <p class="text-xl font-bold text-gray-900 mb-1">💰 Money Example:</p>
                            <p class="text-lg text-gray-700">
                                You save **4 dollars** from allowance. You earn **3 dollars** from doing chores.
                                Your total savings is 4 + 3 = **7 dollars**!
                            </p>
                        </div>

                        <!-- Example 5: Building Blocks -->
                        <div class="p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-500 shadow-md">
                            <p class="text-xl font-bold text-gray-900 mb-1">🧱 Building Block Example:</p>
                            <p class="text-lg text-gray-700">
                                You start building a tower with 10 large blocks. You find 8 smaller blocks to add to the top.
                                Your complete tower uses 10 + 8 = 18 blocks.
                            </p>
                        </div>
                    </div>
                    
                    <button id="startTestButton" class="btn-option bg-emerald-500 text-white font-black py-4 px-8 rounded-full text-2xl shadow-xl hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition duration-150 ease-in-out">
                        Start Practice Test! (Level ${Math.floor(skillLevel)})
                    </button>
                </div>
            `;
            
            // Set up the button to start the test
            document.getElementById('startTestButton').onclick = () => {
                lessonContentArea.classList.add('hidden');
                scoreInfo.classList.remove('hidden');
                optionsContainer.classList.remove('hidden');

                // *** FIX: Explicitly ensure the Hint Button and Visualization are visible for the test ***
                visualizationArea.style.display = 'flex'; // Show visualization when test starts
                document.getElementById('hintButton').style.display = 'block'; // Show hint button when test starts
                
                generateProblem(); // Start the actual game problems
            };

            feedbackMessage.textContent = "Welcome to Addition practice! Read the examples above to understand the concept.";
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-blue-100 text-blue-700';
        }


        /**
         * Function to generate arithmetic problems (only supports addition for now)
         */
        function generateProblem() {
            hintUsed = false;

            if (!currentOperation) {
                console.error("Attempted to generate problem without selecting an operation.");
                return;
            }

            // Determine difficulty bounds based on skill level
            let max = Math.floor(skillLevel) * 10;
            if (skillLevel <= 2) max = Math.min(20, max);
            else if (skillLevel <= 5) max = 50;
            else max = 99; // Cap for base 10 visuals for now

            let num1, num2, answer;
            let problemStr;

            if (currentOperation === '+') {
                num1 = Math.floor(Math.random() * (max - 1)) + 1;
                num2 = Math.floor(Math.random() * (max - 1)) + 1;
                answer = num1 + num2;
                problemStr = `${num1} + ${num2} = ?`;
            } else {
                // Placeholder for other operations (Subtraction, Multiplication, Division)
                problemStr = `Problem generation not implemented for ${currentOperation} yet.`;
                answer = 0;
                num1 = 0; num2 = 0;
            }

            currentProblem = {
                num1: num1,
                num2: num2,
                operator: currentOperation,
                answer: answer,
                problemStr: problemStr
            };
            
            displayProblem();
            displayOptions();
            // Visualization is rendered here when practice starts
            renderVisualization(num1, num2, currentOperation); 
        }

        function displayProblem() {
            problemTextElement.textContent = currentProblem.problemStr;
            problemContainer.classList.add('problem-glow');
            // Hint button is shown here when problems are active (Redundant but safe)
            hintButton.style.display = 'block'; 
        }

        function displayOptions() {
            optionsContainer.innerHTML = '';
            
            const correctAnswer = currentProblem.answer;
            const options = new Set();
            options.add(correctAnswer);

            // Generate distraction answers
            while (options.size < 4) {
                let distraction;
                const offset = Math.floor(Math.random() * (OPTIONS_RANGE * 2)) - OPTIONS_RANGE; // -5 to +4
                
                // Ensure distraction is not the correct answer and is not negative
                distraction = Math.max(1, correctAnswer + offset); 
                
                if (distraction !== correctAnswer) {
                    options.add(distraction);
                }
            }

            const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);

            optionsContainer.className = 'grid grid-cols-2 sm:grid-cols-4 gap-4';

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'btn-option bg-indigo-500 text-white font-black py-4 rounded-xl text-3xl shadow-lg hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150 ease-in-out';
                button.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        function showHint() {
            hintUsed = true;
            
            let hintText = `Look at the blocks below! Combine the two sets of blocks to find the total.`;
            
            if (currentOperation === '-') {
                hintText = `Look at the blocks below! The crossed-out blocks show the amount being taken away.`;
            } 
            
            feedbackMessage.textContent = `💡 Hint: ${hintText}`;
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-200 text-yellow-900';
            hintButton.style.display = 'none'; // Hide hint button after use
        }

        /**
         * Simulates AI Adaptive Difficulty Adjustment
         */
        function adjustSkill(isCorrect) {
            if (isCorrect) {
                consecutiveCorrects += (hintUsed ? 0 : 1); 
                
                if (consecutiveCorrects >= CORRECT_STREAK_REQUIRED) {
                    skillLevel = Math.min(10, skillLevel + 1); 
                    consecutiveCorrects = 0; 
                    feedbackMessage.textContent = `🥳 SKILL LEVEL UP! You answered ${CORRECT_STREAK_REQUIRED} questions in a row! The problems just got tougher.`;
                    feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-300 text-purple-900 font-extrabold shadow-2xl';
                } else {
                    feedbackMessage.textContent = `🥳 Correct! You need ${CORRECT_STREAK_REQUIRED - consecutiveCorrects} more to level up!`;
                    feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-green-100 text-green-700';
                }
            } else {
                skillLevel = Math.max(1, skillLevel - 0.5); 
                consecutiveCorrects = 0; 
                feedbackMessage.textContent = `❌ That's okay! Streak reset. Let's try another one.`;
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-red-100 text-red-700';
            }

            skillLevelDisplay.textContent = Math.floor(skillLevel);
            hintUsed = false; 
        }
        
        // --- Number Type Learning Logic (Kept for completeness) ---
        
        function displayNumberTypeOptions() {
            // Hide all problem-related elements
            lessonContentArea.classList.add('hidden');
            scoreInfo.classList.add('hidden');
            regroupingToggleContainer.style.display = 'none';

            problemContainer.classList.remove('hidden');
            optionsContainer.classList.remove('hidden');
            problemTextElement.textContent = "Select a Number Concept to Explore:";
            problemContainer.classList.remove('problem-glow');
            hintButton.style.display = 'none'; // Hide hint button in lesson mode
            optionsContainer.innerHTML = ''; 
            optionsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 gap-4';
            visualizationArea.style.display = 'none'; // Ensure visualization is hidden

            Object.keys(numberTypeLessons).forEach(key => {
                const lesson = numberTypeLessons[key];
                const button = document.createElement('button');
                button.innerHTML = `<span class="text-4xl block mb-2">${lesson.icon}</span> ${lesson.title}`;
                button.className = 'btn-option bg-emerald-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition duration-150 ease-in-out h-full flex flex-col justify-center items-center';
                button.onclick = () => generateNumberTypeLesson(key);
                optionsContainer.appendChild(button);
            });
            feedbackMessage.textContent = "Learn about the core building blocks of math!";
        }

        function generateNumberTypeLesson(categoryKey) {
            const lesson = numberTypeLessons[categoryKey];
            visualizationArea.style.display = 'none';
            problemContainer.classList.add('hidden');
            optionsContainer.classList.add('hidden');
            lessonContentArea.classList.remove('hidden');
            lessonContentArea.innerHTML = ''; 

            const lessonHTML = `
                <div class="space-y-6">
                    <div class="bg-purple-100 p-6 rounded-2xl shadow-xl border-b-4 border-purple-700">
                        <h1 class="text-4xl sm:text-5xl font-extrabold text-purple-900 mb-2 flex items-center">
                            <span class="text-6xl mr-3">${lesson.icon}</span> ${lesson.title}
                        </h1>
                        <p class="text-xl text-gray-800">${lesson.summary}</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-emerald-500">
                        <h3 class="text-3xl font-extrabold text-emerald-700 mb-4">Conceptual Examples</h3>
                        <div id="lessonExamples" class="space-y-4"></div>
                    </div>

                    <button id="goBackButton" class="btn-option bg-indigo-500 text-white font-bold py-3 px-6 rounded-xl text-xl shadow-lg hover:bg-indigo-600 w-full transition duration-150 ease-in-out flex items-center justify-center">
                        <span class="mr-2">←</span> Choose Another Concept
                    </button>
                </div>
            `;
            lessonContentArea.innerHTML = lessonHTML;

            const examplesContainer = lessonContentArea.querySelector('#lessonExamples');
            lesson.examples.forEach(example => {
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'p-4 bg-emerald-50 rounded-lg shadow-md border-l-4 border-emerald-600';
                exampleDiv.innerHTML = `<p class="text-lg font-bold text-gray-900">${example.title}</p><p class="text-base text-gray-700">${example.text}</p>`;
                examplesContainer.appendChild(exampleDiv);
            });
            
            lessonContentArea.querySelector('#goBackButton').onclick = displayNumberTypeOptions;
            feedbackMessage.textContent = `You're exploring ${lesson.title}!`;
        }
        
        // --- Core Application Logic ---

        /**
         * Switches the primary learning mode.
         */
        function switchMode(newOperation) {
            currentOperation = newOperation;
            const newMode = newOperation === 'place_value' 
                ? 'place_value' 
                : (newOperation === 'number_types' ? 'number_types' : 'arithmetic');
            currentMode = newMode;
            
            // Reset UI states
            lessonContentArea.classList.add('hidden'); // Hide lesson content

            // Manage visibility of core elements based on mode
            const isProblemMode = currentMode === 'arithmetic' || currentMode === 'place_value';
            scoreInfo.classList.toggle('hidden', !isProblemMode);
            // Only show regrouping toggle for Subtraction mode
            regroupingToggleContainer.style.display = currentOperation === '-' ? 'flex' : 'none';

            // Reset problem container structure (to ensure all event listeners are clean)
            problemContainer.classList.remove('hidden'); 
            problemContainer.innerHTML = `
                <p id="problemText" class="text-3xl sm:text-4xl font-black text-purple-900 mb-2">
                    <!-- Content updated by JS -->
                </p>
                <button id="hintButton" class="bg-yellow-500 hover:bg-yellow-600 text-purple-900 font-bold py-2 px-4 rounded-full text-lg transition duration-150 shadow-md">
                    Need a Hint?
                </button>
            `;
            
            // Re-bind the click listener to the NEW hint button element
            const newHintBtn = document.getElementById('hintButton');
            if (newHintBtn) newHintBtn.addEventListener('click', showHint);
            
            // Ensure the hint button is initially hidden for + mode tutorial, and shown for others
            if (newHintBtn) newHintBtn.style.display = (currentOperation === '+' || !isProblemMode) ? 'none' : 'block';

            if (currentOperation === '+') {
                 // Addition now starts with a tutorial, hiding vis and hint
                 displayAdditionTutorial();
            } else if (isProblemMode) {
                 // Other arithmetic modes start directly into problems (vis and hint visible)
                optionsContainer.classList.remove('hidden');
                visualizationArea.style.display = 'flex';
                optionsContainer.className = 'grid grid-cols-2 sm:grid-cols-4 gap-4'; // Reset grid for answers
                generateProblem(); // Start problems immediately
            } else if (currentMode === 'number_types') {
                // Number Types Mode
                visualizationArea.style.display = 'none';
                optionsContainer.classList.remove('hidden');
                displayNumberTypeOptions();
            }

            // Update button styles
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.classList.remove('active-op');
                if (btn.dataset.op === currentOperation) {
                    btn.classList.add('active-op');
                }
            });
        }

        /**
         * Resets the game score and starts a new problem/lesson.
         */
        function resetGame(fullReset = true) {
            score = 0;
            scoreElement.textContent = score;
            
            if (fullReset) {
                skillLevel = 1;
                consecutiveCorrects = 0;
            }
            skillLevelDisplay.textContent = Math.floor(skillLevel);

            feedbackMessage.textContent = `Mode reset! Starting a new session.`;
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-100 text-yellow-700';

            setTimeout(() => {
                feedbackMessage.textContent = "Choose your action!";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
                
                if (currentOperation === '+') {
                    displayAdditionTutorial(); // Restart tutorial
                } else if (currentMode === 'number_types') {
                    displayNumberTypeOptions();
                } else if (currentOperation) { // If a problem mode was selected
                    // Use switchMode to ensure all settings are correctly reset
                    switchMode(currentOperation);
                } else {
                    setInitialState();
                }
            }, 1000);
        }
        
        /**
         * Sets the application state to its initial, neutral welcome screen.
         */
        function setInitialState() {
            currentOperation = null;
            currentMode = 'initial';

            scoreInfo.classList.add('hidden');
            regroupingToggleContainer.style.display = 'none';
            lessonContentArea.classList.add('hidden');
            optionsContainer.classList.add('hidden');
            
            problemContainer.classList.remove('hidden');
            problemContainer.classList.remove('problem-glow');
            problemTextElement.textContent = "Select an operation to begin!";

            hintButton.style.display = 'none';
            
            // Neutralize button styles
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.classList.remove('active-op');
            });

            // Set default visualization message
            visualizationArea.style.display = 'flex';
            visualizationArea.className = 'visual-container bg-purple-900/90 rounded-xl mb-4 text-center flex flex-col justify-center items-center';
            visualizationArea.innerHTML = '<p class="text-white text-xl p-4">Select an operation to begin learning with interactive visualizations!</p>';

            feedbackMessage.textContent = "Choose your operation above to start learning!";
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
        }


        // --- Initialization ---

        /**
         * Initializes the game.
         */
        window.onload = function() {
            document.getElementById('resetButton').addEventListener('click', () => resetGame(true));
            
            // Initial binding for the hint button (before any innerHTML changes)
            hintButton.addEventListener('click', showHint);

            // Setup mode selector listeners
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.addEventListener('click', () => {
                    const op = btn.dataset.op;
                    switchMode(op);
                });
            });

            // Setup Regrouping Toggle listener and initial state
            regroupingToggle.checked = showRegrouping; // Sync initial state
            regroupingToggle.addEventListener('change', (event) => {
                showRegrouping = event.target.checked;
                if (currentOperation === '-') {
                    renderVisualization(currentProblem.num1, currentProblem.num2, currentOperation);
                }
            });
            
            // Handle the visual update for the switch's dot position on load and click
            const initialDot = regroupingToggle.closest('.toggle-switch-container').querySelector('.dot');
            const updateDotPosition = (checked) => {
                initialDot.style.transform = checked ? 'translateX(100%)' : 'translateX(0)';
            };

            updateDotPosition(showRegrouping);

            regroupingToggle.addEventListener('click', (e) => {
                updateDotPosition(e.target.checked);
            });


            // Start in the neutral initial state
            setInitialState(); 
        };
    </script>

</body>
</html>

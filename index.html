<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Universe: Adaptive & Inclusive Learning</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* High Contrast Space Background */
            background: linear-gradient(135deg, #0f002a 0%, #3a005c 50%, #6d008d 100%);
            min-height: 100vh;
        }
        .math-card {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px; /* Slightly wider for the new buttons */
        }
        .btn-option, .btn-mode {
            transition: all 0.15s ease-in-out;
            border: 3px solid transparent;
        }
        .btn-option:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .problem-glow {
            animation: pulse-glow 2s infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 10px #ffeb3b, 0 0 20px #ffeb3b4d; }
            to { box-shadow: 0 0 20px #ffeb3b, 0 0 30px #ffeb3b80; }
        }
        
        .animate-ping-once {
            animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1) 1;
        }
        @keyframes ping {
          75%, 100% {
            transform: scale(1.1);
            opacity: 0;
          }
        }
        
        .visual-container {
            min-height: 120px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 1rem;
        }

        /* --- Simple Symbol Style (for Concrete Phase) --- */
        .simple-symbol {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* --- Base-Ten Block Styles (for Pictorial Phase) --- */
        /* Unit/One Block (Cube) */
        .one-block {
            width: 15px;
            height: 15px;
            margin: 2px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        /* Ten Block (Rod) */
        .ten-block {
            width: 15px;
            height: 70px; /* Represents 10 stacked units */
            margin: 4px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        /* Hundred Block (Flat) - Used mainly in Place Value mode */
        .hundred-block {
            width: 70px;
            height: 70px;
            margin: 4px 6px;
            border-radius: 6px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
        }

        /* Style for crossed out blocks/symbols (Subtraction/Regrouping) */
        .block-crossed {
            position: relative;
            opacity: 0.4;
        }
        .block-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: #dc2626; /* Red line */
            transform: translateY(-50%) rotate(-45deg);
            opacity: 1;
            border-radius: 1px;
        }

        /* High contrast colors for operations */
        .op-add { background-color: #059669; } /* Emerald */
        .op-sub { background-color: #dc2626; } /* Red */
        .op-mul { background-color: #f59e0b; } /* Amber */
        .op-div { background-color: #3b82f6; } /* Blue */
        .op-place { background-color: #9333ea; } /* Violet */

        .active-op {
            background-color: #facc15 !important; /* Yellow */
            color: #4c1d95 !important; /* Purple text */
            box-shadow: 0 0 0 4px #facc15, 0 0 15px rgba(255, 255, 0, 0.7);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <!-- Main Application Container -->
    <div id="app" class="w-full">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-yellow-300 tracking-tight mb-2">
                <span role="img" aria-label="Globe">ðŸŒŽ</span> Math Universe
            </h1>
            <p class="text-xl text-indigo-200">Learning Made Visual, Adaptive, and Free</p>
        </header>

        <!-- Math Card -->
        <div class="math-card bg-white p-6 sm:p-8 rounded-3xl shadow-2xl">
            
            <!-- Mode and Info Bar -->
            <div class="space-y-4 mb-6 border-b pb-4 border-indigo-100">
                
                <!-- Operation/Mode Selector (Now separate buttons) -->
                <div id="modeSelector" class="grid grid-cols-3 sm:grid-cols-5 gap-3">
                    <button data-op="+" data-mode="arithmetic" class="btn-mode op-add text-white font-bold py-3 rounded-xl shadow-md">Addition (+)</button>
                    <button data-op="-" data-mode="arithmetic" class="btn-mode op-sub text-white font-bold py-3 rounded-xl shadow-md">Subtraction (-)</button>
                    <button data-op="*" data-mode="arithmetic" class="btn-mode op-mul text-white font-bold py-3 rounded-xl shadow-md">Multiplication (Ã—)</button>
                    <button data-op="/" data-mode="arithmetic" class="btn-mode op-div text-white font-bold py-3 rounded-xl shadow-md">Division (Ã·)</button>
                    <button data-op="place_value" data-mode="place_value" class="btn-mode op-place text-white font-bold py-3 rounded-xl shadow-md">Place Value</button>
                </div>

                <!-- Score, Level & Reset -->
                <div class="flex justify-between items-center">
                    <div class="text-lg font-bold text-gray-700">
                        Score: <span id="score" class="text-green-600">0</span>
                    </div>
                    <div class="text-lg font-bold text-gray-700">
                        Skill Level: <span id="skillLevelDisplay" class="text-purple-600">1</span>
                    </div>
                    <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-150">
                        Reset Game
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="mainContent">
                <!-- Visualization Area (Arithmetic & Place Value) -->
                <div id="visualizationArea" class="visual-container bg-purple-900/90 rounded-xl mb-4 text-center">
                    <!-- Visual elements will be drawn here -->
                </div>

                <!-- Problem and Hint Display -->
                <div id="problemContainer" class="problem-glow text-center p-6 bg-purple-100 rounded-xl mb-6">
                    <p id="problemText" class="text-3xl sm:text-4xl font-black text-purple-900 mb-2">
                        Select an operation to begin!
                    </p>
                    <button id="hintButton" class="bg-yellow-500 hover:bg-yellow-600 text-purple-900 font-bold py-2 px-4 rounded-full text-lg transition duration-150 shadow-md">
                        Need a Hint?
                    </button>
                </div>

                <!-- Options/Buttons -->
                <div id="optionsContainer" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Feedback Message -->
            <div id="feedbackContainer" class="mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center">
                <p id="feedbackMessage" class="text-lg font-semibold text-gray-600">Choose your operation above to start learning!</p>
            </div>
        </div>
        
        <!-- Accessibility Note -->
        <p class="text-center text-sm text-indigo-200 mt-4">
            Note: This layout uses high-contrast colors and clear, consistent visuals, supporting learners with various needs.
        </p>
    </div>

    <!-- JavaScript Game Logic -->
    <script>
        // Global variables for game state
        let score = 0;
        let skillLevel = 1; // AI-like adaptive difficulty
        let currentProblem = {};
        let currentMode = 'arithmetic'; 
        let currentOperation = '+'; // Default to addition
        let hintUsed = false;

        // Settings
        const MAX_OPERAND_BASE = 5;
        const OPTIONS_RANGE = 5;
        const VISUAL_COMPLEXITY_THRESHOLD = 50; 
        // Start using Base-Ten Blocks (Pictorial) at Skill Level 3. Below is Simple Symbols (Concrete).
        const BASE_TEN_THRESHOLD = 3; 
        const SIMPLE_SYMBOL_MAX_COUNT = 10; // Max count for which we use the simple 1:1 symbol visualization

        // DOM elements
        const scoreElement = document.getElementById('score');
        const skillLevelDisplay = document.getElementById('skillLevelDisplay');
        const problemTextElement = document.getElementById('problemText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const problemContainer = document.getElementById('problemContainer');
        const visualizationArea = document.getElementById('visualizationArea');
        const hintButton = document.getElementById('hintButton');


        // --- Utility Functions ---

        /**
         * Utility function to shuffle an array (Fisher-Yates)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Simulates AI Adaptive Difficulty Adjustment
         */
        function adjustSkill(isCorrect) {
            if (isCorrect) {
                // Increase difficulty slightly faster for correct answers
                skillLevel = Math.min(10, skillLevel + (hintUsed ? 0.2 : 0.5));
            } else {
                // Decrease difficulty on incorrect answer
                skillLevel = Math.max(1, skillLevel - 1);
            }
            // Update display without announcing the level change explicitly
            skillLevelDisplay.textContent = Math.floor(skillLevel);
            hintUsed = false; // Reset hint tracking
        }
        
        /**
         * Renders simple 1:1 symbols (dots/beads) for low skill/small numbers (Concrete phase).
         * @param {number} totalCount - The total number of units in the group.
         * @param {number} countToCrossOut - The number of symbols to cross out (0 for addition).
         * @param {string} colorClass - The Tailwind color class for the blocks.
         * @returns {HTMLElement} The container element with symbols.
         */
        const renderSimpleSymbols = (totalCount, countToCrossOut, colorClass) => {
            const container = document.createElement('div');
            container.className = 'flex flex-wrap justify-center m-2 p-2 rounded-lg bg-white/10 shadow-inner max-w-full';

            const maxUnits = Math.min(totalCount, VISUAL_COMPLEXITY_THRESHOLD); 
            
            for (let i = 0; i < maxUnits; i++) {
                const symbol = document.createElement('span');
                // Apply cross-out if we still need to mark items to be taken away
                const isCrossed = i < countToCrossOut; 

                symbol.className = `simple-symbol ${colorClass} ${isCrossed ? 'block-crossed' : ''}`;
                container.appendChild(symbol);
            }
            
            if (totalCount > maxUnits) {
                const note = document.createElement('p');
                note.className = 'text-sm text-indigo-200 w-full mt-2';
                note.textContent = `... plus ${totalCount - maxUnits} more symbols.`;
                container.appendChild(note);
            }
            
            const note = document.createElement('p');
            note.className = 'text-sm text-indigo-200 w-full mt-2';
            note.textContent = `(Concrete Counting: ${totalCount} units. ${countToCrossOut > 0 ? `Take Away: ${countToCrossOut}` : ''})`;
            container.appendChild(note);

            return container;
        };


        /**
         * Renders Base-Ten Elements (Ones Units and Tens Rods) for arithmetic (Pictorial phase).
         * @param {number} totalCount - The total number of units in the group.
         * @param {number} countToCrossOut - The number of symbols to cross out (0 for addition).
         * @param {string} colorClass - The Tailwind color class for the blocks.
         * @returns {HTMLElement} The container element with blocks.
         */
        const renderBaseTenElements = (totalCount, countToCrossOut, colorClass) => {
            const container = document.createElement('div');
            container.className = 'flex flex-wrap justify-center m-2 p-2 rounded-lg bg-white/10 shadow-inner max-w-full';

            const tens = Math.floor(totalCount / 10);
            const ones = totalCount % 10;
            let remainingToCross = countToCrossOut;
            
            // Render 10s Blocks (Rods)
            for (let i = 0; i < tens; i++) {
                const block = document.createElement('div');
                // Cross out the required number of tens rods (visual approximation of regrouping)
                const isCrossed = remainingToCross >= 10; 
                if (isCrossed) {
                    remainingToCross -= 10;
                }
                
                block.className = `ten-block ${colorClass} ${isCrossed ? 'block-crossed' : ''}`;
                container.appendChild(block);
            }

            // Render 1s Units (Cubes)
            const onesContainer = document.createElement('div');
            onesContainer.className = 'flex flex-wrap max-w-[120px] mx-2'; // Group the ones units
            for (let i = 0; i < ones; i++) {
                const mark = document.createElement('span');
                // Cross out the required number of ones units
                const isCrossed = remainingToCross > 0;
                if (isCrossed) {
                    remainingToCross--;
                }

                mark.className = `one-block ${colorClass} ${isCrossed ? 'block-crossed' : ''}`;
                onesContainer.appendChild(mark);
            }
            container.appendChild(onesContainer);

            if (totalCount > 0) {
                const note = document.createElement('p');
                note.className = 'text-sm text-indigo-200 w-full mt-2';
                note.textContent = `(Pictorial Place Value: ${tens} Tens Rods and ${ones} Ones Units. ${countToCrossOut > 0 ? `Take Away: ${countToCrossOut}` : ''})`;
                container.appendChild(note);
            }

            return container;
        };

        /**
         * Decides which visual rendering method to use based on skill level and number size.
         */
        const renderMathVisuals = (count, countToCrossOut, colorClass) => {
             // 1. Simple Symbols (Concrete) for small numbers and low skill levels
            if (skillLevel < BASE_TEN_THRESHOLD || count <= SIMPLE_SYMBOL_MAX_COUNT) {
                return renderSimpleSymbols(count, countToCrossOut, colorClass);
            } 
            // 2. Base-Ten Blocks (Pictorial) for larger numbers and higher skill levels
            else {
                return renderBaseTenElements(count, countToCrossOut, colorClass);
            }
        };


        // --- Visualization & Rendering ---

        /**
         * Renders the visual representation based on the current mode/operation.
         */
        function renderVisualization() {
            visualizationArea.innerHTML = '';
            visualizationArea.style.display = 'flex';
            hintButton.style.display = currentMode === 'place_value' ? 'none' : 'block';

            if (currentMode === 'place_value') {
                renderPlaceValueVisuals();
                return;
            }

            // Arithmetic Visuals
            const { num1, num2, operation } = currentProblem;
            
            const opSymbol = document.createElement('div');
            opSymbol.className = 'text-5xl text-yellow-300 font-extrabold flex items-center justify-center p-4';
            opSymbol.textContent = operation === '*' ? 'Ã—' : (operation === '/' ? 'Ã·' : operation);

            if (operation === '+') {
                // Addition: Two distinct groups being combined
                visualizationArea.className = 'visual-container flex-row items-start bg-purple-900/90 rounded-xl mb-4 text-center';
                
                // Group 1: Yellow Symbols/Blocks
                const group1 = renderMathVisuals(num1, 0, 'bg-yellow-400');
                visualizationArea.appendChild(group1);
                visualizationArea.appendChild(opSymbol);

                // Group 2: Pink Symbols/Blocks for Addition
                const group2 = renderMathVisuals(num2, 0, 'bg-pink-400');
                visualizationArea.appendChild(group2);

            } else if (operation === '-') {
                // Subtraction: One starting group (num1) with num2 items crossed out
                visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';
                
                const heading = document.createElement('p');
                heading.className = 'text-white text-xl font-semibold mb-2';
                heading.textContent = `Start with ${num1}. Cross out ${num2} units to find the answer.`;
                visualizationArea.appendChild(heading);

                // Single Group: Yellow Symbols/Blocks with num2 marked as crossed out
                const singleGroup = renderMathVisuals(num1, num2, 'bg-yellow-400');
                visualizationArea.appendChild(singleGroup);

            } else if (operation === '*' || operation === '/') {
                if (operation === '*') {
                    // Multiplication: Array/Area Model (Equal Groups)
                    const totalElements = num1 * num2;
                    visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';

                    if (totalElements > VISUAL_COMPLEXITY_THRESHOLD) {
                        // High-performance text/area model representation for large numbers
                        visualizationArea.innerHTML = `
                            <p class="text-white text-3xl font-bold p-4">Multiplication: Array/Area Model</p>
                            <p class="text-indigo-200 text-xl font-medium">
                                Think of an array with ${num1} rows and ${num2} columns. 
                                Total size is too large to display all units ($${num1} \\times ${num2}$).
                            </p>
                            <div class="bg-yellow-400 text-purple-900 p-2 rounded-lg mt-3 font-mono text-xl">
                                ${num1} $\\times$ ${num2}
                            </div>
                        `;
                    } else {
                        // Small visual for smaller numbers
                        const numGroups = num1; 
                        const groupSize = num2; 

                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'flex flex-wrap justify-center items-start p-2 max-w-full';

                        for (let i = 0; i < numGroups; i++) {
                            const groupBlock = document.createElement('div');
                            groupBlock.className = 'flex flex-col items-center m-2 p-3 rounded-xl bg-white/20 border-2 border-yellow-500/50';
                            
                            const label = document.createElement('p');
                            label.className = 'text-base font-bold text-yellow-300 mb-1';
                            label.textContent = `Group ${i + 1} (${groupSize})`;
                            groupBlock.appendChild(label);
                            
                            // Use simple units (dots) for multiplication visualization
                            const units = renderSimpleSymbols(groupSize, 0, 'bg-lime-400'); 
                            groupBlock.appendChild(units);

                            groupContainer.appendChild(groupBlock);
                        }
                        visualizationArea.appendChild(groupContainer);
                        visualizationArea.innerHTML += `<p class="text-white text-xl mt-4 font-semibold">This is ${numGroups} equal groups of ${groupSize}.</p>`;
                    }

                } else if (operation === '/') {
                    // Division: High-level explanation (Equal Sharing or Grouping)
                    visualizationArea.innerHTML = `<p class="text-white text-2xl font-bold p-4">Division: Equal Sharing or Grouping</p><p class="text-indigo-200">Start with the total (${num1}). How many times can you make a group of size ${num2}? The answer is the number of groups.</p>`;
                    visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';
                }
            }
        }

        /**
         * Renders the Place Value visualization (Hundreds, Tens, Ones).
         */
        function renderPlaceValueVisuals() {
            const { num1, targetDigit, targetPlace, answer } = currentProblem;
            visualizationArea.innerHTML = '';
            visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';
            
            /**
             * Helper to render the decomposition into blocks.
             */
            const renderBlocks = (number, highlightPlace) => {
                // Ensure the number is treated as a three-digit string for consistent parsing
                const numStr = String(number).padStart(3, '0');
                const digits = numStr.split('').map(Number);
                
                // Adjust indices based on actual number length for correct digit mapping
                const h = digits.length === 3 ? digits[0] : 0;
                const t = digits.length >= 2 ? digits[digits.length - 2] : 0;
                const o = digits[digits.length - 1];
                
                const blockContainer = document.createElement('div');
                blockContainer.className = 'flex justify-center mb-4 flex-wrap';

                // Helper to render columns of blocks
                const renderColumn = (count, label, blockType, blockColor, placeName) => {
                    const isHighlighted = placeName === highlightPlace;
                    // Use a brighter color and ring for the highlighted column
                    const highlightClass = isHighlighted ? 'bg-yellow-500/20 ring-4 ring-yellow-300' : 'bg-white/10';
                    const col = document.createElement('div');
                    col.className = `flex flex-col items-center mx-4 my-2 p-3 rounded-lg shadow-inner transition duration-300 ${highlightClass}`;
                    
                    // Label text color
                    const labelColor = isHighlighted ? 'text-yellow-300' : 'text-yellow-500';

                    col.innerHTML = `<p class="text-lg font-bold ${labelColor} mb-1">${label}</p>`;
                    
                    if (blockType !== 'one-block') {
                         for (let i = 0; i < count; i++) {
                            const block = document.createElement('div');
                            block.className = `${blockType} ${blockColor} m-1 rounded shadow-lg`;
                            col.appendChild(block);
                        }
                    } else {
                        // Group the ones units for better visual organization
                        const onesContainer = document.createElement('div');
                        onesContainer.className = 'flex flex-wrap max-w-[100px] justify-center';
                        for(let i=0; i < count; i++) {
                            const unit = document.createElement('div');
                            unit.className = 'one-block bg-yellow-500';
                            onesContainer.appendChild(unit);
                        }
                        col.appendChild(onesContainer);
                    }

                    // Show the digit count at the bottom
                    col.innerHTML += `<p class="text-white font-extrabold text-2xl mt-2">${count}</p>`;
                    
                    // Show the VALUE of the highlighted column
                    if (isHighlighted) {
                        col.innerHTML += `<p class="text-red-400 font-extrabold text-base mt-1">Value: ${currentProblem.answer}</p>`;
                    }
                    return col;
                };

                // Render Hundreds if needed
                if (number >= 100) {
                    blockContainer.appendChild(renderColumn(h, 'Hundreds', 'hundred-block', 'bg-violet-500', 'hundreds'));
                }
                // Render Tens if needed
                if (number >= 10 || number === 0) { // Always show tens and ones for numbers > 9
                    blockContainer.appendChild(renderColumn(t, 'Tens', 'ten-block', 'bg-blue-500', 'tens'));
                }
                // Render Ones
                blockContainer.appendChild(renderColumn(o, 'Ones', 'one-block', 'bg-yellow-500', 'ones'));
                
                visualizationArea.appendChild(blockContainer);
            };

            
            visualizationArea.innerHTML += `<p class="text-white text-3xl font-bold mb-4">Target Number: <span class="text-yellow-300">${num1}</span></p>`;
            visualizationArea.innerHTML += `<p class="text-white text-lg mb-4">The number is decomposed into **Base-Ten Blocks** (Pictorial) below. Pay attention to the highlighted column!</p>`;
            
            // Render blocks for the generated number and highlight the target place
            renderBlocks(num1, targetPlace); 
            
            // Set the final question in the problem box
            problemTextElement.textContent = `In the number ${num1}, what is the **VALUE** of the digit **${targetDigit}** (the ${targetPlace} place)?`; 
            
            visualizationArea.innerHTML += `<p class="text-indigo-200 text-xl mt-4">Which option equals the total value of the blocks in the ${targetPlace} column?</p>`;

            // Since we set the prompt text here, we need to call displayOptions manually
            displayOptions();
        }

        // --- Problem Generation ---

        /**
         * Generates a new problem based on current mode, operation, and skill level.
         */
        function generateProblem() {
            let num1, num2, answer;
            const factor = Math.floor(skillLevel / 2) + 1; 

            const max = MAX_OPERAND_BASE + (factor * 5); 
            const maxAnswer = max * 2; 

            if (currentMode === 'place_value') {
                
                // Max number generated increases with skill level, up to 999
                const maxNum = Math.min(999, 99 + factor * 100); 
                num1 = Math.floor(Math.random() * (maxNum - 10)) + 10; // Ensure at least a two-digit number

                const numStr = String(num1);
                const digits = numStr.split('').map(Number);
                // Determines available places based on the number length
                const places = ['ones', 'tens', 'hundreds'].slice(0, digits.length).reverse(); 

                // Select a random place to quiz the user on (ensure the digit is not 0 in the target place for now)
                let targetPlace, targetDigit;
                let validPlaces = places.filter(place => {
                    if (place === 'ones' && digits[digits.length - 1] !== 0) return true;
                    if (place === 'tens' && digits.length >= 2 && digits[digits.length - 2] !== 0) return true;
                    if (place === 'hundreds' && digits.length === 3 && digits[digits.length - 3] !== 0) return true;
                    return false;
                });
                
                // If all digits are 0 (e.g., 100, 20), allow the 0 digit to be the target for the smaller place
                if (validPlaces.length === 0) validPlaces = places;

                targetPlace = validPlaces[Math.floor(Math.random() * validPlaces.length)];

                let placeValue; // The numerical value: 1, 10, or 100
                
                if (targetPlace === 'ones') {
                    targetDigit = digits[digits.length - 1];
                    placeValue = 1;
                } else if (targetPlace === 'tens') {
                    targetDigit = digits[digits.length - 2];
                    placeValue = 10;
                } else if (targetPlace === 'hundreds') {
                    targetDigit = digits[digits.length - 3];
                    placeValue = 100;
                }

                // The correct answer is the actual VALUE (e.g., 7 * 10 = 70)
                answer = targetDigit * placeValue; 

                // Store problem data
                currentProblem = {
                    num1,
                    targetDigit,
                    targetPlace,
                    answer,
                    operation: 'place_value',
                    options: []
                };

                // Generate options: The target digit, the target digit's value, and two incorrect values
                let options = new Set([answer]);
                
                // Add the target digit itself (a very common mistake in place value)
                options.add(targetDigit); 
                
                // Add incorrect options: based on nearby values or incorrect place value (e.g., 700 instead of 70)
                while (options.size < 4) { 
                    let incorrect = 0;

                    if (Math.random() < 0.5) {
                         // Incorrect: Off by one place value (e.g., if answer is 70, suggest 7 or 700)
                        if (placeValue === 10) {
                            incorrect = Math.random() < 0.5 ? targetDigit * 1 : targetDigit * 100;
                        } else if (placeValue === 1) {
                            incorrect = targetDigit * 10;
                        } else if (placeValue === 100) {
                            incorrect = targetDigit * 10;
                        }
                    } else {
                        // Incorrect: Off by a small amount from the correct answer
                        incorrect = answer + (Math.floor(Math.random() * 2) * placeValue);
                    }
                    
                    if (incorrect >= 0 && incorrect !== answer && incorrect <= 1000) {
                        options.add(incorrect);
                    }
                }
                currentProblem.options = shuffleArray(Array.from(options));


            } else { 
                // --- ARITHMETIC MODE (Original Logic) ---
                const operation = currentOperation;

                if (operation === '+') {
                    num1 = Math.floor(Math.random() * max) + 1;
                    num2 = Math.floor(Math.random() * max) + 1;
                    answer = num1 + num2;
                } else if (operation === '-') {
                    num1 = Math.floor(Math.random() * max) + 1;
                    num2 = Math.floor(Math.random() * max) + 1;
                    if (num1 < num2) [num1, num2] = [num2, num1];
                    answer = num1 - num2;
                } else if (operation === '*') {
                    // Keep multiplication factors small at lower levels, but allow for growth
                    const multMax = Math.min(25, 5 + factor * 2); 
                    num1 = Math.floor(Math.random() * multMax) + 1;
                    num2 = Math.floor(Math.random() * multMax) + 1;
                    answer = num1 * num2;
                } else if (operation === '/') {
                    const divisorMax = Math.min(15, 3 + factor * 2);
                    num2 = Math.floor(Math.random() * divisorMax) + 2; 
                    let quotient = Math.floor(Math.random() * (max * 2 / num2)) + 1; 
                    num1 = num2 * quotient; 
                    answer = quotient;
                }
                
                // Generate unique incorrect options for arithmetic
                let options = new Set([answer]);
                while (options.size < 4) { 
                    let incorrect;
                    if (Math.random() > 0.5) {
                        incorrect = answer + Math.floor(Math.random() * OPTIONS_RANGE) + 1;
                    } else {
                        incorrect = answer - Math.floor(Math.random() * OPTIONS_RANGE) - 1;
                    }
                    
                    if (incorrect >= 0) { // Keep options non-negative
                        options.add(incorrect);
                    }
                }

                currentProblem = {
                    num1,
                    num2,
                    operation: currentOperation,
                    answer,
                    options: shuffleArray(Array.from(options)),
                };
            }
            
            // For Place Value mode, the problem text and options are set in renderPlaceValueVisuals
            if (currentMode !== 'place_value') {
                displayProblem();
            }
            
            renderVisualization(); 
        }

        /**
         * Displays the problem prompt and options.
         */
        function displayProblem() {
            const opSymbol = currentProblem.operation === '*' ? 'Ã—' : (currentProblem.operation === '/' ? 'Ã·' : currentProblem.operation);
            problemTextElement.textContent = `What is ${currentProblem.num1} ${opSymbol} ${currentProblem.num2}?`;
            displayOptions();
        }

        /**
         * Populates the options buttons. Used by both arithmetic and place_value modes.
         */
        function displayOptions() {
            optionsContainer.innerHTML = ''; 

            currentProblem.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'btn-option bg-indigo-500 text-white font-bold py-4 rounded-xl text-3xl shadow-lg hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150 ease-in-out';
                button.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        // --- Interaction Logic ---

        /**
         * Shows the visual hint (the answer visualization) briefly.
         */
        function showHint() {
            hintUsed = true;
            // Temporarily replace the problem text with the answer
            const opSymbol = currentProblem.operation === '*' ? 'Ã—' : (currentProblem.operation === '/' ? 'Ã·' : currentProblem.operation);
            const originalText = currentMode === 'place_value' 
                ? `In the number ${currentProblem.num1}, what is the **VALUE** of the digit **${currentProblem.targetDigit}** (the ${currentProblem.targetPlace} place)?`
                : `What is ${currentProblem.num1} ${opSymbol} ${currentProblem.num2}?`;

            problemTextElement.textContent = `The answer is: ${currentProblem.answer}. Now, can you find it?`;
            
            feedbackMessage.textContent = "Hint used! Your score won't increase as much, but you'll still learn!";
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-100 text-yellow-700';

            // Reset the message after 3 seconds
            setTimeout(() => {
                problemTextElement.textContent = originalText;
                feedbackMessage.textContent = "Choose the correct answer!";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
            }, 3000);
        }

        /**
         * Checks the user's selected answer and adapts difficulty.
         */
        function checkAnswer(selectedAnswer) {
            document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = true);
            const selectedAnswerNum = Number(selectedAnswer);

            if (selectedAnswerNum === currentProblem.answer) {
                // Correct Answer
                score += hintUsed ? 0 : 1;
                scoreElement.textContent = Math.floor(score);
                adjustSkill(true);

                feedbackMessage.textContent = "ðŸ¥³ Correct! Your skill level is adapting...";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-green-100 text-green-700';
                
                problemContainer.classList.add('animate-ping-once');
                
                setTimeout(() => {
                    document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = false);
                    problemContainer.classList.remove('animate-ping-once');
                    
                    // FIX: Use setTimeout(0) to defer the synchronous generateProblem call
                    setTimeout(generateProblem, 0);
                }, 1000); 

            } else {
                // Incorrect Answer
                adjustSkill(false);
                feedbackMessage.textContent = `âŒ That's okay! The correct answer was ${currentProblem.answer}. Let's try another one.`;
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-red-100 text-red-700';
                
                setTimeout(() => {
                    document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = false);
                    feedbackMessage.textContent = "Choose the correct answer!";
                    feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
                    
                    // FIX: Use setTimeout(0) to defer the synchronous generateProblem call
                    setTimeout(generateProblem, 0);
                }, 2500);
            }
        }

        /**
         * Switches the primary learning mode.
         */
        function switchMode(newOperation) {
            currentOperation = newOperation;
            currentMode = newOperation === 'place_value' ? 'place_value' : 'arithmetic';
            resetGame(false); // Reset score, but keep skill level

            // Update button styles
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.classList.remove('active-op');
                if (btn.dataset.op === currentOperation) {
                    btn.classList.add('active-op');
                }
            });

            // generateProblem is called via resetGame's deferred call
            // generateProblem(); 
        }

        /**
         * Resets the game score and starts a new problem.
         */
        function resetGame(fullReset = true) {
            score = 0;
            scoreElement.textContent = score;
            if (fullReset) skillLevel = 1;
            skillLevelDisplay.textContent = Math.floor(skillLevel);

            feedbackMessage.textContent = `Game reset! New challenge loaded.`;
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-100 text-yellow-700';

            // Clear the feedback after a moment and generate a new problem
            setTimeout(() => {
                feedbackMessage.textContent = "Choose the correct answer!";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
                
                // FIX: Use setTimeout(0) to defer the synchronous generateProblem call
                setTimeout(generateProblem, 0);
            }, 1000);
        }

        /**
         * Initializes the game.
         */
        window.onload = function() {
            document.getElementById('resetButton').addEventListener('click', () => resetGame(true));
            hintButton.addEventListener('click', showHint);

            // Setup mode selector listeners
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.addEventListener('click', () => {
                    const op = btn.dataset.op;
                    switchMode(op);
                });
            });

            // Start in the default Addition mode
            switchMode('+'); 
        };
    </script>

</body>
</html>

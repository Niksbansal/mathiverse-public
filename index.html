<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Universe: Adaptive & Inclusive Learning</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* High Contrast Space Background */
            background: linear-gradient(135deg, #0f002a 0%, #3a005c 50%, #6d008d 100%);
            min-height: 100vh;
        }
        .math-card {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px; /* Slightly wider for the new buttons */
        }
        .btn-option, .btn-mode {
            transition: all 0.15s ease-in-out;
            border: 3px solid transparent;
        }
        .btn-option:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .problem-glow {
            animation: pulse-glow 2s infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 10px #ffeb3b, 0 0 20px #ffeb3b4d; }
            to { box-shadow: 0 0 20px #ffeb3b, 0 0 30px #ffeb3b80; }
        }
        
        .animate-ping-once {
            animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1) 1;
        }
        @keyframes ping {
          75%, 100% {
            transform: scale(1.1);
            opacity: 0;
          }
        }
        
        .visual-container {
            min-height: 120px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 1rem;
        }
        /* Style for the tally marks (visual counting/subtraction) */
        .tally-mark {
            display: inline-block;
            width: 8px;
            height: 35px;
            background: currentColor;
            margin: 0 3px;
            border-radius: 2px;
            position: relative;
        }
        .tally-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -5px;
            right: -5px;
            height: 4px;
            background: red;
            transform: translateY(-50%) rotate(-45deg);
            opacity: 0.8;
            border-radius: 2px;
        }
        /* High contrast colors for operations */
        .op-add { background-color: #059669; } /* Emerald */
        .op-sub { background-color: #dc2626; } /* Red */
        .op-mul { background-color: #f59e0b; } /* Amber */
        .op-div { background-color: #3b82f6; } /* Blue */
        .op-place { background-color: #9333ea; } /* Violet */

        .active-op {
            background-color: #facc15 !important; /* Yellow */
            color: #4c1d95 !important; /* Purple text */
            box-shadow: 0 0 0 4px #facc15, 0 0 15px rgba(255, 255, 0, 0.7);
        }
        /* Custom style for the crossed out ten block */
        .ten-block-crossed {
            position: relative;
            overflow: hidden;
            background-color: #9ca3af; /* Gray for crossed out */
        }
        .ten-block-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: red;
            transform: translateY(-50%) rotate(-45deg);
            opacity: 0.8;
            border-radius: 2px;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <!-- Main Application Container -->
    <div id="app" class="w-full">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-yellow-300 tracking-tight mb-2">
                <span role="img" aria-label="Globe">🌎</span> Math Universe
            </h1>
            <p class="text-xl text-indigo-200">Learning Made Visual, Adaptive, and Free</p>
        </header>

        <!-- Math Card -->
        <div class="math-card bg-white p-6 sm:p-8 rounded-3xl shadow-2xl">
            
            <!-- Mode and Info Bar -->
            <div class="space-y-4 mb-6 border-b pb-4 border-indigo-100">
                
                <!-- Operation/Mode Selector (Now separate buttons) -->
                <div id="modeSelector" class="grid grid-cols-3 sm:grid-cols-5 gap-3">
                    <button data-op="+" data-mode="arithmetic" class="btn-mode op-add text-white font-bold py-3 rounded-xl shadow-md">Addition (+)</button>
                    <button data-op="-" data-mode="arithmetic" class="btn-mode op-sub text-white font-bold py-3 rounded-xl shadow-md">Subtraction (-)</button>
                    <button data-op="*" data-mode="arithmetic" class="btn-mode op-mul text-white font-bold py-3 rounded-xl shadow-md">Multiplication (×)</button>
                    <button data-op="/" data-mode="arithmetic" class="btn-mode op-div text-white font-bold py-3 rounded-xl shadow-md">Division (÷)</button>
                    <button data-op="place_value" data-mode="place_value" class="btn-mode op-place text-white font-bold py-3 rounded-xl shadow-md">Place Value</button>
                </div>

                <!-- Score, Level & Reset -->
                <div class="flex justify-between items-center">
                    <div class="text-lg font-bold text-gray-700">
                        Score: <span id="score" class="text-green-600">0</span>
                    </div>
                    <div class="text-lg font-bold text-gray-700">
                        Skill Level: <span id="skillLevelDisplay" class="text-purple-600">1</span>
                    </div>
                    <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-150">
                        Reset Game
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="mainContent">
                <!-- Visualization Area (Arithmetic & Place Value) -->
                <div id="visualizationArea" class="visual-container bg-purple-900/90 rounded-xl mb-4 text-center">
                    <!-- Visual elements will be drawn here -->
                </div>

                <!-- Problem and Hint Display -->
                <div id="problemContainer" class="problem-glow text-center p-6 bg-purple-100 rounded-xl mb-6">
                    <p id="problemText" class="text-3xl sm:text-4xl font-black text-purple-900 mb-2">
                        Select an operation to begin!
                    </p>
                    <button id="hintButton" class="bg-yellow-500 hover:bg-yellow-600 text-purple-900 font-bold py-2 px-4 rounded-full text-lg transition duration-150 shadow-md">
                        Need a Hint?
                    </button>
                </div>

                <!-- Options/Buttons -->
                <div id="optionsContainer" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Feedback Message -->
            <div id="feedbackContainer" class="mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center">
                <p id="feedbackMessage" class="text-lg font-semibold text-gray-600">Choose your operation above to start learning!</p>
            </div>
        </div>
        
        <!-- Accessibility Note -->
        <p class="text-center text-sm text-indigo-200 mt-4">
            Note: This layout uses high-contrast colors and clear, consistent visuals, supporting learners with various needs.
        </p>
    </div>

    <!-- JavaScript Game Logic -->
    <script>
        // Global variables for game state
        let score = 0;
        let skillLevel = 1; // AI-like adaptive difficulty
        let currentProblem = {};
        let currentMode = 'arithmetic'; 
        let currentOperation = '+'; // Default to addition
        let hintUsed = false;

        // Settings
        const MAX_OPERAND_BASE = 5;
        const OPTIONS_RANGE = 5;
        // Threshold for switching visualization complexity (e.g., total elements > 50)
        const VISUAL_COMPLEXITY_THRESHOLD = 50; 

        // DOM elements
        const scoreElement = document.getElementById('score');
        const skillLevelDisplay = document.getElementById('skillLevelDisplay');
        const problemTextElement = document.getElementById('problemText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const problemContainer = document.getElementById('problemContainer');
        const visualizationArea = document.getElementById('visualizationArea');
        const hintButton = document.getElementById('hintButton');


        // --- Utility Functions ---

        /**
         * Utility function to shuffle an array (Fisher-Yates)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Simulates AI Adaptive Difficulty Adjustment
         */
        function adjustSkill(isCorrect) {
            if (isCorrect) {
                // Increase difficulty slightly faster for correct answers
                skillLevel = Math.min(10, skillLevel + (hintUsed ? 0.2 : 0.5));
            } else {
                // Decrease difficulty on incorrect answer
                skillLevel = Math.max(1, skillLevel - 1);
            }
            // Update display without announcing the level change explicitly
            skillLevelDisplay.textContent = Math.floor(skillLevel);
            hintUsed = false; // Reset hint tracking
        }
        
        /**
         * Renders the tally marks, adapting to Base-Ten grouping at higher skill levels.
         * @param {number} count - The number of tallies to render.
         * @param {string} colorName - The color for the tallies (e.g., 'yellow', 'pink', 'lime').
         * @param {boolean} [isCrossed=false] - If true, apply the cross-out style (for subtraction).
         * @returns {HTMLElement} The tally container element.
         */
        const renderTallies = (count, colorName, isCrossed = false) => {
            const colorMap = {
                'yellow': '#facc15', // Tailwind yellow-400
                'pink': '#f472b6',   // Tailwind pink-400
                'lime': '#a3e635',   // Tailwind lime-400
                'red': '#ef4444'     // Tailwind red-500
            };

            const tallies = document.createElement('div');
            tallies.className = 'flex flex-wrap justify-center m-2 p-2 rounded-lg bg-white/10 shadow-inner max-w-full';
            tallies.style.color = colorMap[colorName] || colorMap.yellow;

            // Use Base-Ten Grouping for counts > 10 and if skill level is slightly higher (CPA - Pictorial)
            const useBaseTen = count > 10 && skillLevel >= 3;

            if (useBaseTen) {
                const tens = Math.floor(count / 10);
                const ones = count % 10;
                
                // Render 10s Blocks (Rectangles)
                for (let i = 0; i < tens; i++) {
                    const block = document.createElement('div');
                    const colorClass = isCrossed ? 'ten-block-crossed' : `bg-current text-white`;
                    // Stylized 'Ten' block
                    block.className = `w-8 h-8 ${colorClass} m-1 rounded shadow-md flex items-center justify-center text-xs font-bold`;
                    block.innerHTML = `<span class="z-10">${isCrossed ? '' : '10'}</span>`; // Text is removed if crossed out for clarity
                    tallies.appendChild(block);
                }

                // Render 1s Tallies (small marks)
                for (let i = 0; i < ones; i++) {
                    const mark = document.createElement('span');
                    mark.className = `tally-mark ${isCrossed ? 'tally-crossed' : ''}`;
                    tallies.appendChild(mark);
                }

                if (count > 0) {
                    const note = document.createElement('p');
                    note.className = 'text-sm text-indigo-200 w-full mt-2';
                    note.textContent = `(Base-Ten Concept: ${tens} Tens and ${ones} Ones)`;
                    tallies.appendChild(note);
                }


            } else {
                // Simple Tally marks for smaller numbers/lower skill (CPA - Concrete/1:1)
                const maxTallies = Math.min(count, VISUAL_COMPLEXITY_THRESHOLD); 
                
                for (let i = 0; i < maxTallies; i++) {
                    const mark = document.createElement('span');
                    mark.className = `tally-mark ${isCrossed ? 'tally-crossed' : ''}`;
                    tallies.appendChild(mark);
                }
                
                // If we capped the tallies, show a note.
                if (count > maxTallies) {
                    const note = document.createElement('p');
                    note.className = 'text-sm text-indigo-200 w-full mt-2';
                    note.textContent = `... plus ${count - maxTallies} more items.`;
                    tallies.appendChild(note);
                }
            }


            return tallies;
        };


        // --- Visualization & Rendering ---

        /**
         * Renders the visual representation based on the current mode/operation.
         */
        function renderVisualization() {
            visualizationArea.innerHTML = '';
            visualizationArea.style.display = 'flex';
            hintButton.style.display = currentMode === 'place_value' ? 'none' : 'block'; // Hide hint for Place Value (it's the visualization itself)

            if (currentMode === 'place_value') {
                renderPlaceValueVisuals();
                return;
            }

            // Arithmetic Visuals
            const { num1, num2, operation } = currentProblem;
            
            const opSymbol = document.createElement('div');
            opSymbol.className = 'text-5xl text-yellow-300 font-extrabold flex items-center justify-center p-4';
            opSymbol.textContent = operation === '*' ? '×' : (operation === '/' ? '÷' : operation);

            if (operation === '+' || operation === '-') {
                // Visual for Addition (Counting) or Subtraction (Crossing out)
                visualizationArea.className = 'visual-container flex-row items-center bg-purple-900/90 rounded-xl mb-4 text-center';
                
                // Group 1: Yellow Tallies (Always present)
                const group1 = renderTallies(num1, 'yellow');
                visualizationArea.appendChild(group1);
                visualizationArea.appendChild(opSymbol);

                if (operation === '+') {
                    // Group 2: Pink Tallies for Addition
                    const group2 = renderTallies(num2, 'pink');
                    visualizationArea.appendChild(group2);
                } else if (operation === '-') {
                    // Group 2: Red Tallies for Subtraction (crossing out the amount being subtracted)
                    const group2 = renderTallies(num2, 'red', true); // Cross out the subtracted amount
                    visualizationArea.appendChild(group2);
                }
            } else if (operation === '*' || operation === '/') {
                if (operation === '*') {
                    // Check for complexity threshold to avoid lag
                    const totalElements = num1 * num2;
                    visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';

                    if (totalElements > VISUAL_COMPLEXITY_THRESHOLD) {
                        // High-performance text/area model representation for large numbers (CPA - Abstract/Pictorial Area)
                        visualizationArea.innerHTML = `
                            <p class="text-white text-3xl font-bold p-4">Multiplication: Array/Area Model Concept</p>
                            <p class="text-indigo-200 text-xl font-medium">
                                Visualize ${num1} rows of ${num2} items. 
                                Total size is too large to display all elements ($${num1} \\times ${num2}$), 
                                so think of the area of a $${num1} \\times ${num2}$ grid.
                            </p>
                            <div class="bg-yellow-400 text-purple-900 p-2 rounded-lg mt-3 font-mono text-xl">
                                ${num1} $\\times$ ${num2}
                            </div>
                        `;
                    } else {
                        // Original (now safe) visual for smaller numbers (CPA - Pictorial Equal Groups)
                        const numGroups = num1; 
                        const groupSize = num2; 

                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'flex flex-wrap justify-center items-start p-2 max-w-full';

                        for (let i = 0; i < numGroups; i++) {
                            const groupBlock = document.createElement('div');
                            groupBlock.className = 'flex flex-col items-center m-2 p-3 rounded-xl bg-white/20 border-2 border-yellow-500/50';
                            
                            const label = document.createElement('p');
                            label.className = 'text-base font-bold text-yellow-300 mb-1';
                            label.textContent = `Group ${i + 1}`;
                            groupBlock.appendChild(label);
                            
                            const tallies = renderTallies(groupSize, 'lime'); 
                            groupBlock.appendChild(tallies);

                            groupContainer.appendChild(groupBlock);
                        }
                        visualizationArea.appendChild(groupContainer);
                        visualizationArea.innerHTML += `<p class="text-white text-xl mt-4 font-semibold">This is ${numGroups} groups of ${groupSize}.</p>`;
                    }

                } else if (operation === '/') {
                    // Visual for Division - Keep a high-level explanation (CPA - Pictorial Sharing/Grouping)
                    visualizationArea.innerHTML = `<p class="text-white text-2xl font-bold p-4">Division: Equal Sharing or Grouping</p><p class="text-indigo-200">Start with the total (${num1}). How many times can you make a group of size ${num2}?</p>`;
                    visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';
                }
            }
        }

        /**
         * Renders the Place Value visualization (Base-Ten Blocks).
         */
        function renderPlaceValueVisuals() {
            const { num1, num2 } = currentProblem;
            visualizationArea.innerHTML = '';
            visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';
            
            // Function to render the decomposition into blocks
            const renderBlocks = (number) => {
                const numStr = String(number).padStart(3, '0');
                const [h, t, o] = numStr.split('').map(Number);
                
                // We show the resulting number's place values
                const blockContainer = document.createElement('div');
                blockContainer.className = 'flex justify-center mb-4 flex-wrap';

                // Helper to render columns of blocks
                const renderColumn = (count, label, blockColor) => {
                    const col = document.createElement('div');
                    col.className = 'flex flex-col items-center mx-4 my-2 p-3 bg-white/10 rounded-lg shadow-inner';
                    col.innerHTML = `<p class="text-lg font-bold text-yellow-300 mb-1">${label}</p>`;
                    
                    // Render large blocks/rods
                    const blockTypeClass = label.includes('Hundreds') ? 'w-12 h-12' : (label.includes('Tens') ? 'w-6 h-12' : 'w-6 h-6');

                    for (let i = 0; i < count; i++) {
                        const block = document.createElement('div');
                        block.className = `${blockTypeClass} ${blockColor} m-1 rounded shadow-lg`;
                        col.appendChild(block);
                    }
                    // Show the digit count at the bottom
                    col.innerHTML += `<p class="text-white font-extrabold text-2xl mt-2">${count}</p>`;
                    return col;
                };

                // H is Hundreds (Violet), T is Tens (Blue), O is Ones (Yellow)
                blockContainer.appendChild(renderColumn(h, 'Hundreds (100s)', 'bg-violet-500'));
                blockContainer.appendChild(renderColumn(t, 'Tens (10s)', 'bg-blue-500'));
                blockContainer.appendChild(renderColumn(o, 'Ones (1s)', 'bg-yellow-500'));
                
                visualizationArea.appendChild(blockContainer);
            };

            
            visualizationArea.innerHTML += `<p class="text-white text-2xl">First, calculate: ${num1} ${currentProblem.operation} ${num2}</p>`;
            visualizationArea.innerHTML += `<p class="text-white text-lg mb-4">The **result** is ${currentProblem.fullAnswer}. Its Base-Ten decomposition is shown below:</p>`;
            
            // Pass the full answer to renderBlocks
            renderBlocks(currentProblem.fullAnswer); 
            
            // Set the final question in the problem box
            problemTextElement.textContent = `Given the result is ${currentProblem.fullAnswer}, what is the value of the **Hundreds** digit?`; 
            
            visualizationArea.innerHTML += `<p class="text-indigo-200 text-xl mt-4">Which option corresponds to the count of the 'Hundreds' blocks (Violet)?</p>`;
        }

        // --- Problem Generation ---

        /**
         * Generates a new problem based on current mode, operation, and skill level.
         */
        function generateProblem() {
            let num1, num2, answer;
            const factor = Math.floor(skillLevel / 2) + 1; 

            const max = MAX_OPERAND_BASE + (factor * 5); 
            const maxAnswer = max * 2; 

            if (currentMode === 'place_value') {
                const pvMax = 99 * factor; 
                
                // Place Value problem setup (Max result 999)
                currentProblem.operation = Math.random() < 0.7 ? '+' : '-'; 
                
                // Max initial operands that won't result in more than 3 digits usually
                num1 = Math.floor(Math.random() * 499) + 10;
                num2 = Math.floor(Math.random() * 499) + 10;

                if (currentProblem.operation === '-') {
                    if (num1 < num2) [num1, num2] = [num2, num1]; 
                }
                
                let tempAnswer = currentProblem.operation === '+' ? num1 + num2 : num1 - num2;

                // The *actual* answer for the place value question is the hundreds digit of the result
                const hundredsDigit = Math.floor(tempAnswer / 100) % 10;
                answer = hundredsDigit;

                // Store full numbers for the prompt, the full answer for visualization, and the digit as the answer
                currentProblem.num1 = num1;
                currentProblem.num2 = num2;
                currentProblem.operation = currentProblem.operation;
                currentProblem.fullAnswer = tempAnswer; // Store the full number result
                currentProblem.answer = answer; // The final answer is the HUNDREDS DIGIT

                // Max options range for a digit is 0-9
                let options = new Set([answer]);
                while (options.size < 4) { 
                    const incorrect = Math.floor(Math.random() * 10);
                    options.add(incorrect);
                }
                currentProblem.options = shuffleArray(Array.from(options));


            } else { 
                // Arithmetic Mode (+, -, *, /)
                const operation = currentOperation;

                if (operation === '+') {
                    num1 = Math.floor(Math.random() * max) + 1;
                    num2 = Math.floor(Math.random() * max) + 1;
                    answer = num1 + num2;
                } else if (operation === '-') {
                    num1 = Math.floor(Math.random() * max) + 1;
                    num2 = Math.floor(Math.random() * max) + 1;
                    if (num1 < num2) [num1, num2] = [num2, num1];
                    answer = num1 - num2;
                } else if (operation === '*') {
                    // Keep multiplication factors small at lower levels, but allow for growth
                    const multMax = Math.min(25, 5 + factor * 2); 
                    num1 = Math.floor(Math.random() * multMax) + 1;
                    num2 = Math.floor(Math.random() * multMax) + 1;
                    answer = num1 * num2;
                } else if (operation === '/') {
                    const divisorMax = Math.min(15, 3 + factor * 2);
                    num2 = Math.floor(Math.random() * divisorMax) + 2; 
                    let quotient = Math.floor(Math.random() * (max * 2 / num2)) + 1; 
                    num1 = num2 * quotient; 
                    answer = quotient;
                }
                
                // Generate unique incorrect options for arithmetic
                let options = new Set([answer]);
                while (options.size < 4) { 
                    let incorrect;
                    if (Math.random() > 0.5) {
                        incorrect = answer + Math.floor(Math.random() * OPTIONS_RANGE) + 1;
                    } else {
                        incorrect = answer - Math.floor(Math.random() * OPTIONS_RANGE) - 1;
                    }
                    
                    if (incorrect >= 0 && incorrect <= maxAnswer + OPTIONS_RANGE) {
                        options.add(incorrect);
                    }
                }

                currentProblem = {
                    num1,
                    num2,
                    operation: currentOperation,
                    answer,
                    options: shuffleArray(Array.from(options)),
                };
            }
            
            // If it's a place value question, the prompt is set in renderPlaceValueVisuals
            if (currentMode !== 'place_value') {
                displayProblem();
            }
            
            renderVisualization(); 
        }

        /**
         * Displays the problem prompt and options.
         */
        function displayProblem() {
            const opSymbol = currentProblem.operation === '*' ? '×' : (currentProblem.operation === '/' ? '÷' : currentProblem.operation);
            problemTextElement.textContent = `What is ${currentProblem.num1} ${opSymbol} ${currentProblem.num2}?`;
            optionsContainer.innerHTML = ''; 

            currentProblem.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'btn-option bg-indigo-500 text-white font-bold py-4 rounded-xl text-3xl shadow-lg hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150 ease-in-out';
                button.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        // --- Interaction Logic ---

        /**
         * Shows the visual hint (the answer visualization) briefly.
         */
        function showHint() {
            hintUsed = true;
            // Temporarily replace the problem text with the answer
            const opSymbol = currentProblem.operation === '*' ? '×' : (currentProblem.operation === '/' ? '÷' : currentProblem.operation);
            const originalText = `What is ${currentProblem.num1} ${opSymbol} ${currentProblem.num2}?`;

            problemTextElement.textContent = `The answer is: ${currentProblem.answer}. Now, can you find it?`;
            
            feedbackMessage.textContent = "Hint used! Your score won't increase as much, but you'll still learn!";
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-100 text-yellow-700';

            // Reset the message after 3 seconds
            setTimeout(() => {
                problemTextElement.textContent = originalText;
                feedbackMessage.textContent = "Choose the correct answer!";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
            }, 3000);
        }

        /**
         * Checks the user's selected answer and adapts difficulty.
         */
        function checkAnswer(selectedAnswer) {
            document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = true);
            const selectedAnswerNum = Number(selectedAnswer);

            if (selectedAnswerNum === currentProblem.answer) {
                // Correct Answer
                score += hintUsed ? 0 : 1;
                scoreElement.textContent = Math.floor(score);
                adjustSkill(true);

                feedbackMessage.textContent = "🥳 Correct! Your skill level is adapting...";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-green-100 text-green-700';
                
                problemContainer.classList.add('animate-ping-once');
                
                setTimeout(() => {
                    document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = false);
                    problemContainer.classList.remove('animate-ping-once');
                    generateProblem(); // Auto next question
                }, 1000); 

            } else {
                // Incorrect Answer
                adjustSkill(false);
                feedbackMessage.textContent = `❌ That's okay! The correct answer was ${currentProblem.answer}. Let's try another one.`;
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-red-100 text-red-700';
                
                setTimeout(() => {
                    document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = false);
                    feedbackMessage.textContent = "Choose the correct answer!";
                    feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
                    generateProblem(); // Move to next problem
                }, 2500);
            }
        }

        /**
         * Switches the primary learning mode.
         */
        function switchMode(newOperation) {
            currentOperation = newOperation;
            currentMode = newOperation === 'place_value' ? 'place_value' : 'arithmetic';
            resetGame(false); // Reset score, but keep skill level

            // Update button styles
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.classList.remove('active-op');
                if (btn.dataset.op === currentOperation) {
                    btn.classList.add('active-op');
                }
            });

            generateProblem();
        }

        /**
         * Resets the game score and starts a new problem.
         */
        function resetGame(fullReset = true) {
            score = 0;
            scoreElement.textContent = score;
            if (fullReset) skillLevel = 1;
            skillLevelDisplay.textContent = Math.floor(skillLevel);

            feedbackMessage.textContent = `Game reset! New challenge loaded.`;
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-100 text-yellow-700';

            // Clear the feedback after a moment and generate a new problem
            setTimeout(() => {
                feedbackMessage.textContent = "Choose the correct answer!";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
                generateProblem();
            }, 1000);
        }

        /**
         * Initializes the game.
         */
        window.onload = function() {
            document.getElementById('resetButton').addEventListener('click', () => resetGame(true));
            hintButton.addEventListener('click', showHint);

            // Setup mode selector listeners
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.addEventListener('click', () => {
                    const op = btn.dataset.op;
                    switchMode(op);
                });
            });

            // Start in the default Addition mode
            switchMode('+'); 
        };
    </script>

</body>
</html>

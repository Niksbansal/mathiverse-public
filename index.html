<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Universe: Adaptive & Inclusive Learning</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* High Contrast Space Background */
            background: linear-gradient(135deg, #0f002a 0%, #3a005c 50%, #6d008d 100%);
            min-height: 100vh;
        }
        .math-card {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            max-width: 768px; /* Slightly wider for better visual space */
        }
        .btn-option, .btn-mode {
            transition: all 0.15s ease-in-out;
            border: 3px solid transparent;
        }
        .btn-option:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .problem-glow {
            animation: pulse-glow 2s infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 10px #ffeb3b, 0 0 20px #ffeb3b4d; }
            to { box-shadow: 0 0 20px #ffeb3b, 0 0 30px #ffeb3b80; }
        }
        
        /* Fix: Add missing animation for correct answer feedback */
        .animate-ping-once {
            animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1) 1;
        }
        @keyframes ping {
          75%, 100% {
            transform: scale(1.1);
            opacity: 0;
          }
        }
        /* End Fix */
        
        .visual-container {
            min-height: 120px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 1rem;
        }
        /* Style for the tally marks (visual counting/subtraction) */
        .tally-mark {
            display: inline-block;
            width: 8px;
            height: 35px;
            background: currentColor;
            margin: 0 3px;
            border-radius: 2px;
            position: relative;
        }
        .tally-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -5px;
            right: -5px;
            height: 4px;
            background: red;
            transform: translateY(-50%) rotate(-45deg);
            opacity: 0.8;
            border-radius: 2px;
        }
        .star-svg {
            display: inline-block;
            margin: 4px;
            width: 24px;
            height: 24px;
        }
        /* High contrast colors for operations */
        .op-add { background-color: #059669; } /* Emerald */
        .op-sub { background-color: #dc2626; } /* Red */
        .op-mul { background-color: #f59e0b; } /* Amber */
        .op-div { background-color: #3b82f6; } /* Blue */
        .op-place { background-color: #9333ea; } /* Violet */
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <!-- Main Application Container -->
    <div id="app" class="w-full">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-yellow-300 tracking-tight mb-2">
                <span role="img" aria-label="Globe">ðŸŒŽ</span> Math Universe
            </h1>
            <p class="text-xl text-indigo-200">Learning Made Visual, Adaptive, and Free</p>
        </header>

        <!-- Math Card -->
        <div class="math-card bg-white p-6 sm:p-8 rounded-3xl shadow-2xl">
            
            <!-- Mode and Info Bar -->
            <div class="space-y-4 mb-6 border-b pb-4 border-indigo-100">
                
                <!-- Operation/Mode Selector -->
                <div id="modeSelector" class="grid grid-cols-2 sm:grid-cols-5 gap-2">
                    <button data-mode="arithmetic" data-op="+" class="btn-mode op-add text-white font-bold py-3 rounded-xl shadow-md">Add/Subtract</button>
                    <button data-mode="arithmetic" data-op="*" class="btn-mode op-mul text-white font-bold py-3 rounded-xl shadow-md">Multiply/Divide</button>
                    <button data-mode="place_value" class="btn-mode op-place text-white font-bold py-3 rounded-xl shadow-md">Place Value</button>
                    <button data-mode="algebra" class="btn-mode bg-gray-400 text-white font-bold py-3 rounded-xl shadow-md" disabled>Algebra/Trig (Soon)</button>
                    <button data-mode="geometry" class="btn-mode bg-gray-400 text-white font-bold py-3 rounded-xl shadow-md" disabled>Geometry (Soon)</button>
                </div>

                <!-- Score, Level & Reset -->
                <div class="flex justify-between items-center">
                    <div class="text-lg font-bold text-gray-700">
                        Score: <span id="score" class="text-green-600">0</span>
                    </div>
                    <div class="text-lg font-bold text-gray-700">
                        Skill Level: <span id="skillLevelDisplay" class="text-purple-600">1</span>
                    </div>
                    <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-150">
                        Reset Game
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="mainContent">
                <!-- Visualization Area (Arithmetic & Place Value) -->
                <div id="visualizationArea" class="visual-container bg-purple-900/90 rounded-xl mb-4 text-center">
                    <!-- Visual elements will be drawn here -->
                </div>

                <!-- Problem and Hint Display -->
                <div id="problemContainer" class="problem-glow text-center p-6 bg-purple-100 rounded-xl mb-6">
                    <p id="problemText" class="text-3xl sm:text-4xl font-black text-purple-900 mb-2">
                        Loading problem...
                    </p>
                    <button id="hintButton" class="bg-yellow-500 hover:bg-yellow-600 text-purple-900 font-bold py-2 px-4 rounded-full text-lg transition duration-150 shadow-md">
                        Need a Hint?
                    </button>
                </div>

                <!-- Options/Buttons -->
                <div id="optionsContainer" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Feedback Message -->
            <div id="feedbackContainer" class="mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center">
                <p id="feedbackMessage" class="text-lg font-semibold text-gray-600">Select an operation mode to begin!</p>
            </div>
        </div>
        
        <!-- Accessibility Note -->
        <p class="text-center text-sm text-indigo-200 mt-4">
            Note: This layout uses high-contrast colors and clear, consistent visuals, supporting learners with various needs.
        </p>
    </div>

    <!-- JavaScript Game Logic -->
    <script>
        // Global variables for game state
        let score = 0;
        let skillLevel = 1; // AI-like adaptive difficulty
        let currentProblem = {};
        let currentMode = 'arithmetic'; 
        let currentOperation = '+'; 
        let hintUsed = false;
        // Flag to control the initial intentional lag demonstration
        let initialLagDemoDone = false; 

        // Settings
        const MAX_OPERAND_BASE = 5;
        const OPTIONS_RANGE = 5;
        // Threshold for switching visualization complexity (e.g., total elements > 50)
        const VISUAL_COMPLEXITY_THRESHOLD = 50; 

        // DOM elements
        const scoreElement = document.getElementById('score');
        const skillLevelDisplay = document.getElementById('skillLevelDisplay');
        const problemTextElement = document.getElementById('problemText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const problemContainer = document.getElementById('problemContainer');
        const visualizationArea = document.getElementById('visualizationArea');
        const mainContent = document.getElementById('mainContent');
        const hintButton = document.getElementById('hintButton');

        // --- Utility Functions ---

        /**
         * Utility function to cause a temporary, noticeable hang (thread-blocking).
         * Used only for demonstration purposes on the initial load.
         */
        function simulateLag(milliseconds) {
            const start = Date.now();
            while (Date.now() < start + milliseconds) {
                // Tight loop blocks the main thread, causing the hang
            }
        }
        
        /**
         * Utility function to shuffle an array (Fisher-Yates)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Simulates AI Adaptive Difficulty Adjustment
         */
        function adjustSkill(isCorrect) {
            if (isCorrect) {
                // Increase difficulty slightly faster for correct answers
                skillLevel = Math.min(10, skillLevel + (hintUsed ? 0.2 : 0.5));
            } else {
                // Decrease difficulty on incorrect answer
                skillLevel = Math.max(1, skillLevel - 1);
            }
            // Update display without announcing the level change explicitly
            skillLevelDisplay.textContent = Math.floor(skillLevel);
            hintUsed = false; // Reset hint tracking
        }
        
        /**
         * Renders the tally marks for counting, addition, or subtraction.
         * @param {number} count - The number of tallies to render.
         * @param {string} colorName - The color for the tallies (e.g., 'yellow', 'pink', 'lime').
         * @param {boolean} [isCrossed=false] - If true, apply the cross-out style (for subtraction).
         * @returns {HTMLElement} The tally container element.
         */
        const renderTallies = (count, colorName, isCrossed = false) => {
            const colorMap = {
                'yellow': '#facc15', // Tailwind yellow-400
                'pink': '#f472b6',   // Tailwind pink-400
                'lime': '#a3e635',   // Tailwind lime-400
                'red': '#ef4444'     // Tailwind red-500
            };

            const tallies = document.createElement('div');
            tallies.className = 'flex flex-wrap justify-center m-2 p-2 rounded-lg bg-white/10 shadow-inner max-w-full';
            tallies.style.color = colorMap[colorName] || colorMap.yellow;

            for (let i = 0; i < count; i++) {
                const mark = document.createElement('span');
                mark.className = `tally-mark ${isCrossed ? 'tally-crossed' : ''}`;
                tallies.appendChild(mark);
            }
            return tallies;
        };

        // --- Visualization & Rendering ---

        /**
         * Renders the visual representation based on the current mode/operation.
         */
        function renderVisualization() {
            visualizationArea.innerHTML = '';
            visualizationArea.style.display = 'flex';
            hintButton.style.display = 'block';

            if (currentMode === 'place_value') {
                renderPlaceValueVisuals();
                return;
            }

            // Arithmetic Visuals (Counting, Addition, Subtraction, Multiplication)
            const { num1, num2, operation } = currentProblem;
            
            const opSymbol = document.createElement('div');
            opSymbol.className = 'text-5xl text-yellow-300 font-extrabold flex items-center justify-center p-4';
            opSymbol.textContent = operation === '*' ? 'Ã—' : (operation === '/' ? 'Ã·' : operation);

            if (operation === '+' || operation === '-') {
                // Visual for Addition (Counting) or Subtraction (Crossing out)
                visualizationArea.className = 'visual-container flex-row items-center bg-purple-900/90 rounded-xl mb-4 text-center';
                
                // Group 1: Yellow Tallies (Always present)
                const group1 = renderTallies(num1, 'yellow');
                visualizationArea.appendChild(group1);
                visualizationArea.appendChild(opSymbol);

                if (operation === '+') {
                    // Group 2: Pink Tallies for Addition
                    const group2 = renderTallies(num2, 'pink');
                    visualizationArea.appendChild(group2);
                } else if (operation === '-') {
                    // Group 2: Red Tallies for Subtraction (crossing out the amount being subtracted)
                    const group2 = renderTallies(num2, 'red', true); // Cross out the subtracted amount
                    visualizationArea.appendChild(group2);
                }
            } else if (operation === '*' || operation === '/') {
                if (operation === '*') {
                    // Fix: Check for complexity threshold to avoid lag
                    const totalElements = num1 * num2;
                    visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';

                    if (totalElements > VISUAL_COMPLEXITY_THRESHOLD) {
                        // High-performance text/area model representation for large numbers
                        visualizationArea.innerHTML = `
                            <p class="text-white text-3xl font-bold p-4">Multiplication: Area Model Concept</p>
                            <p class="text-indigo-200 text-xl font-medium">
                                Visualize ${num1} rows of ${num2} items. 
                                Total size is too large to display all elements (${totalElements}), 
                                so think of the area of a ${num1} x ${num2} grid.
                            </p>
                            <div class="bg-yellow-400 text-purple-900 p-2 rounded-lg mt-3 font-mono text-xl">
                                ${num1} $\\times$ ${num2}
                            </div>
                        `;
                    } else {
                        // Original (now safe) visual for smaller numbers
                        const numGroups = num1; 
                        const groupSize = num2; 

                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'flex flex-wrap justify-center items-center p-2 max-w-full';

                        for (let i = 0; i < numGroups; i++) {
                            const groupBlock = document.createElement('div');
                            groupBlock.className = 'flex flex-col items-center m-2 p-3 rounded-xl bg-white/20 border-2 border-yellow-500/50';
                            
                            const label = document.createElement('p');
                            label.className = 'text-base font-bold text-yellow-300 mb-1';
                            label.textContent = `Group ${i + 1}`;
                            groupBlock.appendChild(label);
                            
                            const tallies = renderTallies(groupSize, 'lime'); 
                            groupBlock.appendChild(tallies);

                            groupContainer.appendChild(groupBlock);

                            if (i < numGroups - 1) {
                                const plusSignSeparator = document.createElement('div');
                                plusSignSeparator.className = 'text-3xl text-yellow-400 font-extrabold flex items-center justify-center p-2';
                                plusSignSeparator.innerHTML = '&#43;'; 
                                groupContainer.appendChild(plusSignSeparator);
                            }
                        }
                        visualizationArea.appendChild(groupContainer);
                        visualizationArea.innerHTML += `<p class="text-white text-xl mt-4 font-semibold">This is ${numGroups} groups of ${groupSize}.</p>`;
                    }

                } else if (operation === '/') {
                    // Visual for Division - Keep a high-level explanation
                    visualizationArea.innerHTML = `<p class="text-white text-2xl font-bold p-4">Division: How many times does ${num2} fit into ${num1}?</p><p class="text-indigo-200">The total is ${num1}. We are sharing/grouping them by ${num2}.</p>`;
                    visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';
                }
            }
        }

        /**
         * Renders the Place Value visualization.
         */
        function renderPlaceValueVisuals() {
            const { num1, num2 } = currentProblem;
            visualizationArea.innerHTML = '';
            visualizationArea.className = 'visual-container flex-col items-center bg-purple-900/90 rounded-xl mb-4 text-center';
            hintButton.style.display = 'none'; 

            const renderBlocks = (number, color) => {
                const numStr = String(number).padStart(3, '0'); 
                const [h, t, o] = numStr.split('').map(Number);
                
                const container = document.createElement('div');
                container.className = 'flex justify-center my-2 text-white font-bold text-lg';
                container.innerHTML = `
                    <div class="w-1/3 text-center p-2 rounded-l-lg bg-gray-700/50">Hundreds</div>
                    <div class="w-1/3 text-center p-2 bg-gray-700/50">Tens</div>
                    <div class="w-1/3 text-center p-2 rounded-r-lg bg-gray-700/50">Ones</div>
                `;

                const blockContainer = document.createElement('div');
                blockContainer.className = 'flex justify-center mb-4';

                // Helper to render columns of blocks (optimization not needed here as element count is low)
                const renderColumn = (count, label, blockColor) => {
                    const col = document.createElement('div');
                    col.className = 'flex flex-col items-center mx-4';
                    col.innerHTML = `<p class="text-lg font-bold text-yellow-300 mb-1">${label}</p>`;
                    for (let i = 0; i < count; i++) {
                        const block = document.createElement('div');
                        block.className = `w-10 h-10 ${blockColor} m-1 rounded shadow-lg`;
                        col.appendChild(block);
                    }
                    return col;
                };

                // H is Hundreds (Violet), T is Tens (Blue), O is Ones (Yellow)
                blockContainer.appendChild(renderColumn(h, 'Hundreds', 'bg-violet-500'));
                blockContainer.appendChild(renderColumn(t, 'Tens', 'bg-blue-500'));
                blockContainer.appendChild(renderColumn(o, 'Ones', 'bg-yellow-500'));
                
                visualizationArea.appendChild(container);
                visualizationArea.appendChild(blockContainer);
            };

            renderBlocks(num1, 'blue');
            
            const opSymbol = document.createElement('div');
            opSymbol.className = 'text-5xl text-yellow-300 font-extrabold flex items-center justify-center p-4';
            opSymbol.textContent = currentProblem.operation === '+' ? '+' : '-';
            
            renderBlocks(num2, 'pink');
            
            visualizationArea.appendChild(opSymbol);
            visualizationArea.innerHTML += `<p class="text-white text-2xl mt-4">Add or Subtract these place value blocks to find the total/difference.</p>`;

            problemTextElement.textContent = `What is ${num1} ${currentProblem.operation} ${num2}?`;
        }

        // --- Problem Generation ---

        /**
         * Generates a new problem based on current mode, operation, and skill level.
         */
        function generateProblem() {
            // Intentional Lag Demonstration: This function causes the requested hang ONCE.
            if (!initialLagDemoDone) {
                // Hang the main thread for 3 seconds to demonstrate the blocking lag
                simulateLag(3000); 
                initialLagDemoDone = true;
            }

            let num1, num2, answer;
            const factor = Math.floor(skillLevel / 2) + 1; 

            const max = MAX_OPERAND_BASE + (factor * 5); 
            const maxAnswer = max * 2; 

            if (currentMode === 'place_value') {
                currentProblem.operation = Math.random() < 0.7 ? '+' : '-'; 
                const pvMax = 99 * factor; 
                
                num1 = Math.floor(Math.random() * pvMax) + 10;
                num2 = Math.floor(Math.random() * pvMax) + 10;
                
                if (currentProblem.operation === '-') {
                    if (num1 < num2) [num1, num2] = [num2, num1]; 
                }
                // Use a safe calculation method instead of relying solely on eval
                answer = currentProblem.operation === '+' ? num1 + num2 : num1 - num2;

            } else { 
                // Arithmetic Mode (+, -, *, /)
                currentProblem.operation = (skillLevel < 4 && Math.random() < 0.7) ? (Math.random() < 0.5 ? '+' : '-') : (Math.random() < 0.5 ? '*' : '/');
                
                if (currentOperation === '+' || currentOperation === '-') {
                    currentProblem.operation = (currentOperation === '+') ? '+' : '-';
                }
                if (currentOperation === '*' || currentOperation === '/') {
                    currentProblem.operation = (currentOperation === '*') ? '*' : '/';
                }

                if (currentProblem.operation === '+') {
                    num1 = Math.floor(Math.random() * max) + 1;
                    num2 = Math.floor(Math.random() * max) + 1;
                    answer = num1 + num2;
                } else if (currentProblem.operation === '-') {
                    num1 = Math.floor(Math.random() * max) + 1;
                    num2 = Math.floor(Math.random() * max) + 1;
                    if (num1 < num2) [num1, num2] = [num2, num1];
                    answer = num1 - num2;
                } else if (currentProblem.operation === '*') {
                    // Keep multiplication factors small at lower levels, but allow for growth
                    const multMax = Math.min(25, 5 + factor * 2); 
                    num1 = Math.floor(Math.random() * multMax) + 1;
                    num2 = Math.floor(Math.random() * multMax) + 1;
                    answer = num1 * num2;
                } else if (currentProblem.operation === '/') {
                    const divisorMax = Math.min(15, 3 + factor * 2);
                    num2 = Math.floor(Math.random() * divisorMax) + 2; 
                    let quotient = Math.floor(Math.random() * (max * 2 / num2)) + 1; 
                    num1 = num2 * quotient; 
                    answer = quotient;
                }
            }
            
            // Generate unique incorrect options
            let options = new Set([answer]);
            while (options.size < 4) { 
                let incorrect;
                if (Math.random() > 0.5) {
                    incorrect = answer + Math.floor(Math.random() * OPTIONS_RANGE) + 1;
                } else {
                    incorrect = answer - Math.floor(Math.random() * OPTIONS_RANGE) - 1;
                }
                
                if (incorrect >= 0 && incorrect <= maxAnswer + OPTIONS_RANGE) {
                    options.add(incorrect);
                }
            }

            currentProblem = {
                num1,
                num2,
                operation: currentProblem.operation,
                answer,
                options: shuffleArray(Array.from(options)),
            };

            displayProblem();
            renderVisualization(); 
        }

        /**
         * Displays the problem prompt and options.
         */
        function displayProblem() {
            const opSymbol = currentProblem.operation === '*' ? 'Ã—' : (currentProblem.operation === '/' ? 'Ã·' : currentProblem.operation);
            problemTextElement.textContent = `What is ${currentProblem.num1} ${opSymbol} ${currentProblem.num2}?`;
            optionsContainer.innerHTML = ''; 

            currentProblem.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'btn-option bg-indigo-500 text-white font-bold py-4 rounded-xl text-3xl shadow-lg hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150 ease-in-out';
                button.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        // --- Interaction Logic ---

        /**
         * Shows the visual hint (the answer visualization) briefly.
         */
        function showHint() {
            hintUsed = true;
            // Temporarily replace the problem text with the answer
            const originalText = problemTextElement.textContent;
            problemTextElement.textContent = `The answer is: ${currentProblem.answer}. Now, can you find it?`;
            
            feedbackMessage.textContent = "Hint used! Your score won't increase as much, but you'll still learn!";
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-100 text-yellow-700';

            // Reset the message after 3 seconds
            setTimeout(() => {
                problemTextElement.textContent = originalText;
                feedbackMessage.textContent = "Choose the correct answer!";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
            }, 3000);
        }

        /**
         * Checks the user's selected answer and adapts difficulty.
         */
        function checkAnswer(selectedAnswer) {
            document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = true);

            if (selectedAnswer === currentProblem.answer) {
                // Correct Answer
                score += hintUsed ? 0 : 1;
                scoreElement.textContent = Math.floor(score);
                adjustSkill(true);

                feedbackMessage.textContent = "ðŸ¥³ Correct! Your skill level is adapting...";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-green-100 text-green-700';
                
                problemContainer.classList.add('animate-ping-once');
                
                setTimeout(() => {
                    document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = false);
                    problemContainer.classList.remove('animate-ping-once');
                    generateProblem(); // Auto next question
                }, 1000); 

            } else {
                // Incorrect Answer
                adjustSkill(false);
                feedbackMessage.textContent = `âŒ That's okay! The correct answer was ${currentProblem.answer}. Let's try another one.`;
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-red-100 text-red-700';
                
                setTimeout(() => {
                    document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = false);
                    feedbackMessage.textContent = "Choose the correct answer!";
                    feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
                    generateProblem(); // Move to next problem
                }, 2500);
            }
        }

        /**
         * Switches the primary learning mode.
         */
        function switchMode(newMode, newOperation = '+') {
            currentMode = newMode;
            currentOperation = newOperation;
            resetGame(false); // Reset score, but keep skill level

            // Update button styles
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-yellow-300', 'bg-yellow-500');
                if (btn.dataset.mode === 'arithmetic') {
                    if (btn.dataset.op === currentOperation) {
                        btn.classList.add('ring-4', 'ring-yellow-300', 'bg-yellow-500', 'text-purple-900');
                    } else {
                         // Reset non-active arithmetic buttons to their operation color
                        btn.classList.remove('bg-yellow-500', 'text-purple-900');
                        btn.classList.add(btn.dataset.op === '+' ? 'op-add' : 'op-mul', 'text-white');
                    }
                } else if (btn.dataset.mode === currentMode) {
                    btn.classList.add('ring-4', 'ring-yellow-300', 'bg-yellow-500', 'text-purple-900');
                    btn.classList.remove('op-place');
                } else if (btn.dataset.mode === 'place_value') {
                    btn.classList.remove('bg-yellow-500', 'text-purple-900');
                    btn.classList.add('op-place', 'text-white');
                }
            });

            generateProblem();
        }

        /**
         * Resets the game score and starts a new problem.
         */
        function resetGame(fullReset = true) {
            score = 0;
            scoreElement.textContent = score;
            if (fullReset) skillLevel = 1;
            skillLevelDisplay.textContent = Math.floor(skillLevel);

            feedbackMessage.textContent = `Game reset! New challenge loaded.`;
            feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center bg-yellow-100 text-yellow-700';

            // Clear the feedback after a moment
            setTimeout(() => {
                feedbackMessage.textContent = "Choose the correct answer!";
                feedbackContainer.className = 'mt-6 p-4 text-center rounded-lg min-h-[50px] flex items-center justify-center';
                generateProblem();
            }, 1000);
        }

        /**
         * Initializes the game.
         */
        window.onload = function() {
            document.getElementById('resetButton').addEventListener('click', () => resetGame(true));
            hintButton.addEventListener('click', showHint);

            // Setup mode selector listeners
            document.querySelectorAll('.btn-mode').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', () => {
                        const mode = btn.dataset.mode;
                        const op = btn.dataset.op || '+';
                        switchMode(mode, op);
                    });
                }
            });

            // Start in the default Addition/Subtraction mode
            switchMode('arithmetic', '+'); 
            
            // Initial styling for the default active button
            const defaultButton = document.querySelector('[data-mode="arithmetic"][data-op="+"]');
            if (defaultButton) {
                defaultButton.classList.add('ring-4', 'ring-yellow-300', 'bg-yellow-500', 'text-purple-900');
                defaultButton.classList.remove('op-add');
            }
        };
    </script>

</body>
</html>
